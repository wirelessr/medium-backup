<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Making Debezium 2.x Support Confluent Schema Registry</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Making Debezium 2.x Support Confluent Schema Registry</h1>
</header>
<section data-field="subtitle" class="p-summary">
Build a Debezium 2.0 connect image with Avro support
</section>
<section data-field="body" class="e-content">
<section name="f35b" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="bdf3" id="bdf3" class="graf graf--h3 graf--leading graf--title">Making Debezium 2.x Support Confluent Schema Registry</h3><h4 name="4e80" id="4e80" class="graf graf--h4 graf-after--h3 graf--subtitle">Build a Debezium 2.0 connect image with Avro support</h4><figure name="c648" id="c648" class="graf graf--figure graf-after--h4"><img class="graf-image" data-image-id="0*GoqxJ6u9Yg9dI-dN" data-width="1000" data-height="558" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/0*GoqxJ6u9Yg9dI-dN"><figcaption class="imageCaption">Photo by <a href="https://unsplash.com/@anglopic" data-href="https://unsplash.com/@anglopic" class="markup--anchor markup--figure-anchor" rel="noopener" target="_blank">Daniel Cooke</a> on <a href="https://unsplash.com/photos/q_v7QRt7j6g" data-href="https://unsplash.com/photos/q_v7QRt7j6g" class="markup--anchor markup--figure-anchor" rel="noopener" target="_blank">Unsplash</a></figcaption></figure><p name="2d8e" id="2d8e" class="graf graf--p graf-after--figure">We have talked about <a href="https://medium.com/better-programming/real-time-data-infra-stack-73c597ed05ee" data-href="https://medium.com/better-programming/real-time-data-infra-stack-73c597ed05ee" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">how to design a real-time data pipeline</a>, and one of the important components is Debezium. In order to load OLTP databases from various microservices into the data warehouse seamlessly, we often rely on Debezium to do this task.</p><p name="570a" id="570a" class="graf graf--p graf-after--p">In addition, in <a href="https://hackmd.io/HAAXxvRkRguU2gAO9_-49g" data-href="https://hackmd.io/HAAXxvRkRguU2gAO9_-49g" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">previous article</a>, we mentioned the evolutionary features of Apache Avro and the usage of Confluent Schema Registry, which can be integrated to build a more automated real-time data pipeline.</p><p name="5fc2" id="5fc2" class="graf graf--p graf-after--p">Nevertheless, since Debezium 2.0, it removes the native Confluent support, and if we want to use Debezium with Confluent schema registry, we have to build the Debezium Connect images manually.</p><p name="a906" id="a906" class="graf graf--p graf-after--p">The reference is as follows.</p><div name="733c" id="733c" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://debezium.io/documentation/reference/stable/configuration/avro.html#deploying-confluent-schema-registry-with-debezium-containers" data-href="https://debezium.io/documentation/reference/stable/configuration/avro.html#deploying-confluent-schema-registry-with-debezium-containers" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://debezium.io/documentation/reference/stable/configuration/avro.html#deploying-confluent-schema-registry-with-debezium-containers"><strong class="markup--strong markup--mixtapeEmbed-strong">Avro Serialization</strong><br><em class="markup--em markup--mixtapeEmbed-em">A Debezium connector works in the Kafka Connect framework to capture each row-level change in a database by generating…</em>debezium.io</a><a href="https://debezium.io/documentation/reference/stable/configuration/avro.html#deploying-confluent-schema-registry-with-debezium-containers" class="js-mixtapeImage mixtapeImage mixtapeImage--empty u-ignoreBlock" data-media-id="46876b29f1085c8b4946f8215c48b2b0"></a></div><p name="daea" id="daea" class="graf graf--p graf-after--mixtapeEmbed">The original image repository is at <a href="https://github.com/debezium/container-images.git" data-href="https://github.com/debezium/container-images.git" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">GitHub</a>. We can follow the Dockerfile of <code class="markup--code markup--p-code">connect-base/2.0</code> to build the <code class="markup--code markup--p-code">connect-base</code> image.</p><p name="f00b" id="f00b" class="graf graf--p graf-after--p">In addition to the original dependencies, we need more about Confluent supports.</p><ul class="postList"><li name="2ed1" id="2ed1" class="graf graf--li graf-after--p">kafka-connect-avro-converter</li><li name="8a46" id="8a46" class="graf graf--li graf-after--li">kafka-connect-avro-data</li><li name="46c8" id="46c8" class="graf graf--li graf-after--li">kafka-avro-serializer</li><li name="582f" id="582f" class="graf graf--li graf-after--li">kafka-schema-serializer</li><li name="9b4c" id="9b4c" class="graf graf--li graf-after--li">kafka-schema-registry-client</li><li name="12fc" id="12fc" class="graf graf--li graf-after--li">common-config</li><li name="94a9" id="94a9" class="graf graf--li graf-after--li">common-utils</li></ul><p name="8855" id="8855" class="graf graf--p graf-after--li">Therefore, Dockerfile should be as follows.</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="bash" name="e72b" id="e72b" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content">ARG DEBEZIUM_DOCKER_REGISTRY_PRIMARY_NAME<br />FROM <span class="hljs-variable">$DEBEZIUM_DOCKER_REGISTRY_PRIMARY_NAME</span>/kafka:2.0<br /><br />LABEL maintainer=<span class="hljs-string">&quot;Debezium Community&quot;</span><br /><br />USER root<br />RUN microdnf -y install libaio &amp;&amp; microdnf clean all<br />USER kafka<br />EXPOSE 8083<br />VOLUME [<span class="hljs-string">&quot;/kafka/data&quot;</span>,<span class="hljs-string">&quot;/kafka/logs&quot;</span>,<span class="hljs-string">&quot;/kafka/config&quot;</span>]<br />COPY docker-entrypoint.sh /<br />COPY --<span class="hljs-built_in">chown</span>=kafka:kafka log4j.properties <span class="hljs-variable">$KAFKA_HOME</span>/config/log4j.properties<br />COPY docker-maven-download.sh /usr/local/bin/docker-maven-download<br /><span class="hljs-comment">#</span><br /><span class="hljs-comment"># Set up the plugins directory ...</span><br /><span class="hljs-comment">#</span><br />ENV KAFKA_CONNECT_PLUGINS_DIR=<span class="hljs-variable">$KAFKA_HOME</span>/connect \<br />    EXTERNAL_LIBS_DIR=<span class="hljs-variable">$KAFKA_HOME</span>/external_libs \<br />    CONNECT_PLUGIN_PATH=<span class="hljs-variable">$KAFKA_CONNECT_PLUGINS_DIR</span> \<br />    MAVEN_DEP_DESTINATION=<span class="hljs-variable">$KAFKA_HOME</span>/libs \<br />    CONFLUENT_VERSION=7.0.1 \<br />    AVRO_VERSION=1.10.1 \<br />    APICURIO_VERSION=2.2.5.Final \<br />    GUAVA_VERSION=31.0.1-jre<br />RUN <span class="hljs-built_in">mkdir</span> <span class="hljs-string">&quot;<span class="hljs-variable">$KAFKA_CONNECT_PLUGINS_DIR</span>&quot;</span> <span class="hljs-string">&quot;<span class="hljs-variable">$EXTERNAL_LIBS_DIR</span>&quot;</span><br /><span class="hljs-comment">#</span><br /><span class="hljs-comment"># The `docker-entrypoint.sh` script will automatically discover the child directories</span><br /><span class="hljs-comment"># within the $KAFKA_CONNECT_PLUGINS_DIR directory (e.g., `/kafka/connect`), and place</span><br /><span class="hljs-comment"># all of the files in those child directories onto the Java classpath.</span><br /><span class="hljs-comment">#</span><br /><span class="hljs-comment"># The general recommendation is to create a separate child directory for each connector</span><br /><span class="hljs-comment"># (e.g., &quot;debezium-connector-mysql&quot;), and to place that connector&#x27;s JAR files</span><br /><span class="hljs-comment"># and other resource files in that child directory.</span><br /><span class="hljs-comment">#</span><br /><span class="hljs-comment"># However, use a single directory for connectors when those connectors share dependencies.</span><br /><span class="hljs-comment"># This will prevent the classes in the shared dependencies from appearing in multiple JARs</span><br /><span class="hljs-comment"># on the classpath, which results in arcane NoSuchMethodError exceptions.</span><br /><span class="hljs-comment">#</span><br />RUN docker-maven-download confluent kafka-connect-avro-converter <span class="hljs-string">&quot;<span class="hljs-variable">$CONFLUENT_VERSION</span>&quot;</span> fd03a1436f29d39e1807e2fb6f8e415a &amp;&amp; \<br />    docker-maven-download confluent kafka-connect-avro-data <span class="hljs-string">&quot;<span class="hljs-variable">$CONFLUENT_VERSION</span>&quot;</span> d27f30e9eca4ef1129289c626e9ce1f1 &amp;&amp; \<br />    docker-maven-download confluent kafka-avro-serializer <span class="hljs-string">&quot;<span class="hljs-variable">$CONFLUENT_VERSION</span>&quot;</span> c72420603422ef54d61f493ca338187c &amp;&amp; \<br />    docker-maven-download confluent kafka-schema-serializer <span class="hljs-string">&quot;<span class="hljs-variable">$CONFLUENT_VERSION</span>&quot;</span> 9c510db58119ef66d692ae172d5b1204 &amp;&amp; \<br />    docker-maven-download confluent kafka-schema-registry-client <span class="hljs-string">&quot;<span class="hljs-variable">$CONFLUENT_VERSION</span>&quot;</span> 7449df1f5c9a51c3e82e776eb7814bf1 &amp;&amp; \<br />    docker-maven-download confluent common-config <span class="hljs-string">&quot;<span class="hljs-variable">$CONFLUENT_VERSION</span>&quot;</span> aab5670de446af5b6f10710e2eb86894 &amp;&amp; \<br />    docker-maven-download confluent common-utils <span class="hljs-string">&quot;<span class="hljs-variable">$CONFLUENT_VERSION</span>&quot;</span> 74bf5cc6de2748148f5770bccd83a37c &amp;&amp; \<br />    docker-maven-download central org/apache/avro avro <span class="hljs-string">&quot;<span class="hljs-variable">$AVRO_VERSION</span>&quot;</span> 35469fee6d74ecbadce4773bfe3a204c &amp;&amp; \<br />    docker-maven-download apicurio <span class="hljs-string">&quot;<span class="hljs-variable">$APICURIO_VERSION</span>&quot;</span> f7874b2e2a59dfa829242d9a52b44230 &amp;&amp; \<br />    docker-maven-download central com/google/guava guava <span class="hljs-string">&quot;<span class="hljs-variable">$GUAVA_VERSION</span>&quot;</span> bb811ca86cba6506cca5d415cd5559a7<br />ENTRYPOINT [<span class="hljs-string">&quot;/docker-entrypoint.sh&quot;</span>]<br />CMD [<span class="hljs-string">&quot;start&quot;</span>]</span></pre><p name="6037" id="6037" class="graf graf--p graf-after--pre">There are three required environments to specify those versions of dependencies.</p><ul class="postList"><li name="ca38" id="ca38" class="graf graf--li graf-after--p">CONFLUENT_VERSION: 7.0.1</li><li name="46e8" id="46e8" class="graf graf--li graf-after--li">AVRO_VERSION: 1.10.1</li><li name="a7e1" id="a7e1" class="graf graf--li graf-after--li">GUAVA_VERSION: 31.0.1</li></ul><blockquote name="2185" id="2185" class="graf graf--blockquote graf-after--li"><em class="markup--em markup--blockquote-em">Confluent packages rely on Guava, which is a common util package.</em></blockquote><p name="ccf9" id="ccf9" class="graf graf--p graf-after--blockquote">The <a href="https://mvnrepository.com/artifact/io.confluent/kafka-schema-registry-client?repo=confluent-packages" data-href="https://mvnrepository.com/artifact/io.confluent/kafka-schema-registry-client?repo=confluent-packages" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">latest Confluent version</a> is 7.3.3 until now.</p><p name="af25" id="af25" class="graf graf--p graf-after--p"><a href="https://mvnrepository.com/artifact/org.apache.avro/avro" data-href="https://mvnrepository.com/artifact/org.apache.avro/avro" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Avro</a> and <a href="https://mvnrepository.com/artifact/com.google.guava/guava" data-href="https://mvnrepository.com/artifact/com.google.guava/guava" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Guava</a> are located at official maven repo.</p><p name="426c" id="426c" class="graf graf--p graf-after--p">After having <code class="markup--code markup--p-code">connect-base</code>, we can build <code class="markup--code markup--p-code">connect</code> like <a href="https://github.com/debezium/container-images/blob/main/connect/2.0/Dockerfile" data-href="https://github.com/debezium/container-images/blob/main/connect/2.0/Dockerfile" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">main Dockerfile</a> except the base image, which should be our owned.</p><h3 name="81d9" id="81d9" class="graf graf--h3 graf-after--p">Conclusion</h3><p name="4563" id="4563" class="graf graf--p graf-after--h3">Once the image is built, how do we verify the image works?</p><p name="bff0" id="bff0" class="graf graf--p graf-after--p">Here is an official Debezium tutorial.</p><div name="c58f" id="c58f" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://github.com/debezium/debezium-examples/tree/main/tutorial" data-href="https://github.com/debezium/debezium-examples/tree/main/tutorial" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://github.com/debezium/debezium-examples/tree/main/tutorial"><strong class="markup--strong markup--mixtapeEmbed-strong">debezium-examples/tutorial at main · debezium/debezium-examples</strong><br><em class="markup--em markup--mixtapeEmbed-em">This demo automatically deploys the topology of services as defined in the Debezium Tutorial. To use Avro-style…</em>github.com</a><a href="https://github.com/debezium/debezium-examples/tree/main/tutorial" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="e0af77232b6c73ff4e45c177806c7048" data-thumbnail-img-id="0*XnWExJLt0bTVWAql" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*XnWExJLt0bTVWAql);"></a></div><p name="38ca" id="38ca" class="graf graf--p graf-after--mixtapeEmbed">If the built image can pass the tutorial, then the image works.</p><p name="db31" id="db31" class="graf graf--p graf-after--p">By the way, if you need a Debezium 2.0 with Confluent 7.0.1 image, here’s a ready-made.</p><div name="0315" id="0315" class="graf graf--mixtapeEmbed graf-after--p graf--trailing"><a href="https://hub.docker.com/r/wirelessr/debezium-connect-avro" data-href="https://hub.docker.com/r/wirelessr/debezium-connect-avro" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://hub.docker.com/r/wirelessr/debezium-connect-avro"><strong class="markup--strong markup--mixtapeEmbed-strong">Docker</strong><br><em class="markup--em markup--mixtapeEmbed-em">Edit description</em>hub.docker.com</a><a href="https://hub.docker.com/r/wirelessr/debezium-connect-avro" class="js-mixtapeImage mixtapeImage mixtapeImage--empty u-ignoreBlock" data-media-id="ec08bda10ba943c1fc072ab7b0095597"></a></div></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@lazypro" class="p-author h-card">Chunting Wu</a> on <a href="https://medium.com/p/43435a564f21"><time class="dt-published" datetime="2023-04-17T01:46:33.205Z">April 17, 2023</time></a>.</p><p><a href="https://medium.com/@lazypro/making-debezium-2-x-support-confluent-schema-registry-43435a564f21" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on October 21, 2024.</p></footer></article></body></html>