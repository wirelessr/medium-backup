<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>When to Consider Clean Architecture: A Practical Guide</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">When to Consider Clean Architecture: A Practical Guide</h1>
</header>
<section data-field="subtitle" class="p-summary">
Navigating the Path to Clean Code in Real-world Scenarios
</section>
<section data-field="body" class="e-content">
<section name="fcc2" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="9463" id="9463" class="graf graf--h3 graf--leading graf--title">When to Consider Clean Architecture: A Practical Guide</h3><h4 name="e959" id="e959" class="graf graf--h4 graf-after--h3 graf--subtitle">Navigating the Path to Clean Code in Real-world Scenarios</h4><figure name="bb27" id="bb27" class="graf graf--figure graf-after--h4"><img class="graf-image" data-image-id="0*YHkb938mevTOgKrm" data-width="1000" data-height="668" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/0*YHkb938mevTOgKrm"><figcaption class="imageCaption">Photo by <a href="https://unsplash.com/@srosinger3997" data-href="https://unsplash.com/@srosinger3997" class="markup--anchor markup--figure-anchor" rel="noopener" target="_blank">Samantha Gades</a> on <a href="https://unsplash.com/photos/BlIhVfXbi9s" data-href="https://unsplash.com/photos/BlIhVfXbi9s" class="markup--anchor markup--figure-anchor" rel="noopener" target="_blank">Unsplash</a></figcaption></figure><p name="f8f9" id="f8f9" class="graf graf--p graf-after--figure">How to design and implement clean architecture more easily has been described in detail in my previous articles. If you are interested in the details, you can refer to the following series of articles.</p><ul class="postList"><li name="d486" id="d486" class="graf graf--li graf-after--p"><a href="https://betterprogramming.pub/how-to-design-in-clean-architecture-way-part-1-36c3e558517b" data-href="https://betterprogramming.pub/how-to-design-in-clean-architecture-way-part-1-36c3e558517b" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">How to Design Software in a Clean Architecture Way</a></li><li name="4040" id="4040" class="graf graf--li graf-after--li"><a href="https://lazypro.medium.com/combine-domain-driven-design-and-databases-747fa36ec642" data-href="https://lazypro.medium.com/combine-domain-driven-design-and-databases-747fa36ec642" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">Combine Domain-Driven Design and Databases</a></li></ul><p name="2104" id="2104" class="graf graf--p graf-after--li">Instead of deeply diving into how to design and implement a clean architecture, this article will answer a question that we often encounter.</p><blockquote name="e437" id="e437" class="graf graf--blockquote graf-after--p"><em class="markup--em markup--blockquote-em">When should I consider clean architecture?</em></blockquote><p name="75e7" id="75e7" class="graf graf--p graf-after--blockquote">The main reason for asking this question is we often don’t design code with a clean architecture mindset from the start, but rather decide at some point to do a refactoring and introduce clean architecture.</p><p name="1331" id="1331" class="graf graf--p graf-after--p">This is a natural process because we don’t always have the ability to figure out how to encapsulate the domain in the first place, and we don’t always have the time to have a complete design at the beginning.</p><p name="56dd" id="56dd" class="graf graf--p graf-after--p">So, when should we refactor? And how? These two questions will be the core of this article.</p><h3 name="0e1d" id="0e1d" class="graf graf--h3 graf-after--p">Case Study</h3><p name="4e5b" id="4e5b" class="graf graf--p graf-after--h3">To answer these two questions we need a practical example, so let me describe my thought process using a chatbot.</p><p name="3d90" id="3d90" class="graf graf--p graf-after--p">Suppose I want to use a chatbot to implement an accounting program. The reason why I chose chatbot is to avoid complicated interface interactions, I just need to talk to my usual IM App to achieve the goal of accounting.</p><p name="44c2" id="44c2" class="graf graf--p graf-after--p">The overview of chatbot is as follows.</p><figure name="0116" id="0116" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*RcaXq__wEjFFy6dx4oGf_w.png" data-width="1136" data-height="164" src="https://cdn-images-1.medium.com/max/800/1*RcaXq__wEjFFy6dx4oGf_w.png"></figure><p name="8e61" id="8e61" class="graf graf--p graf-after--figure">The user sends commands to the chatbot through a conversation, and the chatbot receives the message, encapsulates it and sends it to a web service via a webhook; the web service extracts the content with the corresponding SDK, processes the commands, and then sends the results back to the user. The process of processing the message involves accessing the database.</p><p name="66ec" id="66ec" class="graf graf--p graf-after--p">The code flow of the app is organized in the following five steps.</p><figure name="44db" id="44db" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*Qnikh3T3Oe0HMpRA-CWQWQ.png" data-width="734" data-height="912" src="https://cdn-images-1.medium.com/max/800/1*Qnikh3T3Oe0HMpRA-CWQWQ.png"></figure><ul class="postList"><li name="888e" id="888e" class="graf graf--li graf-after--figure">Extract: Use SDK to extract the received request.</li><li name="26e2" id="26e2" class="graf graf--li graf-after--li">Parse: Parses the message into a corresponding command.</li><li name="36d1" id="36d1" class="graf graf--li graf-after--li">Handle: Execute the command and generate the result. Interaction with the database also occurs at this stage.</li><li name="98fe" id="98fe" class="graf graf--li graf-after--li">Encapsulate: After handling the request, the result is packaged into the correct format by the SDK.</li><li name="88b9" id="88b9" class="graf graf--li graf-after--li">Send: Finally, the result is sent back to the user.</li></ul><p name="4987" id="4987" class="graf graf--p graf-after--li">The whole core process will be the second and third steps. Without considering the clean architecture, the entire code would look like the following.</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="bash" name="5cd7" id="5cd7" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">if</span> msg == <span class="hljs-string">&#x27;ooo&#x27;</span>:<br />    ret = user_guide()<br /><span class="hljs-keyword">elif</span> msg.count(<span class="hljs-string">&#x27;x&#x27;</span>) &gt; 10:<br />    ret = insert_items()<br /><span class="hljs-keyword">elif</span> <span class="hljs-string">&#x27;oxo&#x27;</span> <span class="hljs-keyword">in</span> msg:<br />    ret = get_report()<br /><span class="hljs-comment"># and so on</span></span></pre><p name="3339" id="3339" class="graf graf--p graf-after--pre">By parsing the msg, we know the command and take the corresponding action, in other words, this is the business logic of the whole program.</p><p name="0722" id="0722" class="graf graf--p graf-after--p">In the above example, we have three kinds of commands and three handlers, which correspond to the three common functions of a accounting program.</p><ol class="postList"><li name="aebf" id="aebf" class="graf graf--li graf-after--p">ask how to use the program.</li><li name="9657" id="9657" class="graf graf--li graf-after--li">write in accounts.</li><li name="b9e8" id="b9e8" class="graf graf--li graf-after--li">generate reports.</li></ol><p name="32fd" id="32fd" class="graf graf--p graf-after--li">I believe that adding a fourth command would be too painful for some people, and I would start thinking about refactoring it at about this point.</p><p name="380e" id="380e" class="graf graf--p graf-after--p">So to answer the first question: when should I consider refactoring with clean architecture?</p><p name="6289" id="6289" class="graf graf--p graf-after--p">The answer is simple: <strong class="markup--strong markup--p-strong">when the requirements keep iterating and the code becomes difficult to maintain</strong>.</p><p name="8535" id="8535" class="graf graf--p graf-after--p">But how to refactor? How to introduce clean architecture?</p><h3 name="917b" id="917b" class="graf graf--h3 graf-after--p">Refactoring</h3><p name="f08a" id="f08a" class="graf graf--p graf-after--h3">According to the above description, we have two main business logics.</p><ol class="postList"><li name="2029" id="2029" class="graf graf--li graf-after--p">Parser</li><li name="3037" id="3037" class="graf graf--li graf-after--li">Handler</li></ol><p name="1a80" id="1a80" class="graf graf--p graf-after--li">Let’s review the onion architecture one more time.</p><figure name="4388" id="4388" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*zEceOXWPW7rIPoXBc9W5kQ.png" data-width="1172" data-height="1076" src="https://cdn-images-1.medium.com/max/800/1*zEceOXWPW7rIPoXBc9W5kQ.png"><figcaption class="imageCaption">Onion Architecture</figcaption></figure><p name="3290" id="3290" class="graf graf--p graf-after--figure">Calling chain has to go from the outside to the inside, and the most inside is business logic.</p><p name="b335" id="b335" class="graf graf--p graf-after--p">So I will plan the refactored components as shown below.</p><figure name="6a3f" id="6a3f" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*wQ3JXbhO6LoZzsYnOgVZRA.png" data-width="942" data-height="1542" src="https://cdn-images-1.medium.com/max/800/1*wQ3JXbhO6LoZzsYnOgVZRA.png"></figure><p name="f35f" id="f35f" class="graf graf--p graf-after--figure">Let me explain these components.</p><ul class="postList"><li name="b6a8" id="b6a8" class="graf graf--li graf-after--p">Controller: Handles the in/out of the webhook and gets the actual message and user id of the caller with the SDK.</li><li name="a829" id="a829" class="graf graf--li graf-after--li">Service:</li></ul><ol class="postList"><li name="35d8" id="35d8" class="graf graf--li graf-after--li">Call <code class="markup--code markup--li-code">Factory</code> to get concrete command.</li><li name="2979" id="2979" class="graf graf--li graf-after--li">Execute <code class="markup--code markup--li-code">Command</code> directly and get the result, may be a string or an exception.</li></ol><ul class="postList"><li name="cb45" id="cb45" class="graf graf--li graf-after--li">Factory: Handles the logic of generating the <code class="markup--code markup--li-code">Command</code>, i.e. the command parser.</li><li name="ab58" id="ab58" class="graf graf--li graf-after--li">Command: Handles the actual business logic, i.e. the handler, and is responsible for converting the result of the <code class="markup--code markup--li-code">repo</code> to a string.</li><li name="cf29" id="cf29" class="graf graf--li graf-after--li">Repo: handles database calls and wrapping the database format into a DTO, no logic involved.</li></ul><p name="b8a1" id="b8a1" class="graf graf--p graf-after--li">Splitting the domain in this way has several advantages.</p><ol class="postList"><li name="684a" id="684a" class="graf graf--li graf-after--p"><code class="markup--code markup--li-code">Factory</code> unit tests only need to have <code class="markup--code markup--li-code">msg</code> and match <code class="markup--code markup--li-code">Command</code> type, the implementation is quite simple.</li><li name="5e13" id="5e13" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code">Command</code> encapsulates the full behavior of individual commands and isolates the database implementation, so unit testing can easily replace the database through dependency injection and just verify business logic.</li><li name="f0f3" id="f0f3" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code">Repo</code> provides an interface to the database and wraps the format of the manipulated data into a DTO, providing a common specification.</li></ol><p name="6346" id="6346" class="graf graf--p graf-after--li">Back to the onion architecture, Factory and Command are considered business logic, i.e., Entity, and Service is responsible for calling the Entity in order and doing the corresponding error handling, which belongs to the middle Use Case layer. The outer Controller handles the SDK and web framework, and calls the Service to get the result.</p><p name="7906" id="7906" class="graf graf--p graf-after--p">The only thing need to discuss is the outermost layer of DB, in the class diagram is actually <code class="markup--code markup--p-code">Mongo Impl</code>, through the implementation interface to make it out of the bottom layer of the calling chain, all the classes will only touch the <code class="markup--code markup--p-code">Repo</code> rather than the implementation of MongoDB. How to explain the source of the calling chain, i.e. the outer layer, is the DB?</p><p name="b5d8" id="b5d8" class="graf graf--p graf-after--p">The reason is that the outer layer of the code needs to prepare a concrete repo of the <code class="markup--code markup--p-code">Mongo Impl</code> and pass it to the <code class="markup--code markup--p-code">Controller</code>. In my current implementation, I’ve changed my approach a little bit by passing the class type instead of instance.</p><p name="e112" id="e112" class="graf graf--p graf-after--p">A similar implementation can be found in my previous Golang tutorial.</p><ul class="postList"><li name="6975" id="6975" class="graf graf--li graf-after--p"><a href="https://github.com/wirelessr/Clean-Architect-in-Golang/blob/master/server.go#L15" data-href="https://github.com/wirelessr/Clean-Architect-in-Golang/blob/master/server.go#L15" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">https://github.com/wirelessr/Clean-Architect-in-Golang/blob/master/server.go#L15</a></li></ul><p name="4227" id="4227" class="graf graf--p graf-after--li">Finally, let’s look at the <code class="markup--code markup--p-code">Factory</code> and <code class="markup--code markup--p-code">Command</code> pieces.</p><p name="ad0f" id="ad0f" class="graf graf--p graf-after--p">First, the <code class="markup--code markup--p-code">Factory</code> decides what kind of <code class="markup--code markup--p-code">Command</code> to generate based on incoming <code class="markup--code markup--p-code">msg</code>.</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="python" name="a2d2" id="a2d2" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CommandFactory</span>:<br /><span class="hljs-meta">  @staticmethod</span><br />  <span class="hljs-keyword">def</span> <span class="hljs-title function_">generate</span>(<span class="hljs-params">msg, uid</span>):<br />    <span class="hljs-keyword">if</span> msg.startswith(<span class="hljs-string">&quot;/&quot;</span>):<br />      <span class="hljs-keyword">if</span> msg == <span class="hljs-string">&#x27;/sum&#x27;</span>:<br />        <span class="hljs-keyword">return</span> command.SummaryCommand(msg, uid)<br /><br />      <span class="hljs-keyword">return</span> command.HelpCommand()<br />    <span class="hljs-keyword">elif</span> msg.count(<span class="hljs-string">&#x27; &#x27;</span>) &gt; <span class="hljs-number">0</span>:<br />      <span class="hljs-keyword">return</span> command.InsertManyCommand(msg, uid)<br />    <br />    <span class="hljs-keyword">return</span> command.HelpCommand()</span></pre><p name="3fcd" id="3fcd" class="graf graf--p graf-after--pre">Then the “Command”, where the actual business logic is executed, and the following examples will only pick one of them as a demonstration.</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="python" name="bdd9" id="bdd9" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">class</span> <span class="hljs-title class_">InsertManyCommand</span>(<span class="hljs-title class_ inherited__">Command</span>):<br />  <span class="hljs-keyword">def</span> <span class="hljs-title function_">execute</span>(<span class="hljs-params">self, repo_cls</span>):<br />    tokens = [x.strip() <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> self.msg.split(<span class="hljs-string">&#x27;,&#x27;</span>)]<br /><br />    data = []<br />    <span class="hljs-keyword">for</span> token <span class="hljs-keyword">in</span> tokens:<br />        item, cost = [t(s) <span class="hljs-keyword">for</span> t,s <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>((<span class="hljs-built_in">str</span>,<span class="hljs-built_in">int</span>), token.split())]<br />        data.append(Item(item, cost))<br />    <br />    repo = repo_cls(self.uid)<br />    success_cnt = repo.insert_many(data)<br />    <span class="hljs-keyword">return</span> <span class="hljs-string">f&#x27;Successfully wrote <span class="hljs-subst">{success_cnt}</span> record(s)&#x27;</span></span></pre><h3 name="9535" id="9535" class="graf graf--h3 graf-after--pre">Conclusion</h3><p name="425d" id="425d" class="graf graf--p graf-after--h3">Let’s go back to the title, when should we start considering clean architecture? I feel the answer is obvious, when we need to change the code but we don’t know where to start, that’s a good time to do it.</p><p name="869c" id="869c" class="graf graf--p graf-after--p">Why do I let my business logic consist of <code class="markup--code markup--p-code">Factory</code> and <code class="markup--code markup--p-code">Command</code>? Because once I’ve clarified the behavioral patterns of the bot, I can clearly recognize that two things are necessary: parsing and handling, so these two corresponding entities are created. In addition, when these two things are separated, the difficulty of unit testing is significantly reduced.</p><p name="456c" id="456c" class="graf graf--p graf-after--p">I can fully test parsing messages, and of course I can test every self-contained command completely.</p><p name="b9df" id="b9df" class="graf graf--p graf-after--p">When we mention clean architecture, will always make people think of hexagonal architecture or domain-driven development and other formal rules, but in practice to make the architecture clean, as long as the basic essentials will be enough, that is, the concept of the onion architecture.</p><p name="e197" id="e197" class="graf graf--p graf-after--p">Some of the design patterns used in this article, such as the factory method or strategy pattern. Even though I didn’t follow the textbook, I was able to achieve a good result.</p><p name="472f" id="472f" class="graf graf--p graf-after--p">When I drew that class diagram, I didn’t actually have a specific design pattern in mind, but rather, it was based on what shape I wanted the code to be organized into. I first thought about how I would like to decouple and individually test a command if I needed to add one, and then I created two components (<code class="markup--code markup--p-code">Factory</code> and <code class="markup--code markup--p-code">Command</code>) with this idea in mind.</p><p name="cf56" id="cf56" class="graf graf--p graf-after--p">Although <code class="markup--code markup--p-code">Factory</code> has a relatively simple role, I indeed thought for a while about what context <code class="markup--code markup--p-code">Command</code> would be responsible for. Take <code class="markup--code markup--p-code">InsertManyCommand</code> for example, there are these options.</p><ul class="postList"><li name="089d" id="089d" class="graf graf--li graf-after--p">The <code class="markup--code markup--li-code">Service</code> is responsible for tokenization and conversion to DTO.</li><li name="d066" id="d066" class="graf graf--li graf-after--li">The <code class="markup--code markup--li-code">Repo</code> is responsible for tokenization and writing directly to the database.</li><li name="e4bc" id="e4bc" class="graf graf--li graf-after--li">The <code class="markup--code markup--li-code">Service</code> handles the presentation of the result string.</li></ul><p name="ac39" id="ac39" class="graf graf--p graf-after--li">All of these were eventually put into <code class="markup--code markup--p-code">Command</code>, because how the strings are split and how the results are presented should be part of the business logic, and naturally should be handled by <code class="markup--code markup--p-code">Command</code>, which is the core of the business logic.</p><p name="ced6" id="ced6" class="graf graf--p graf-after--p">Once we have a concrete idea, we can fill in the details of the class diagram, and then we just need to follow the diagram to write the program exactly as it is designed.</p><p name="c4ad" id="c4ad" class="graf graf--p graf-after--p">Lastly, my thoughts on ORMs. In fact, I don’t use ORMs to implement database access, but rather use <code class="markup--code markup--p-code">pymongo</code> with a custom DTO.</p><p name="fd08" id="fd08" class="graf graf--p graf-after--p">Why don’t I just use an ORM? The reason is that ORM will make developers overlook the existence of database and make clean architecture difficult to achieve.</p><p name="1cee" id="1cee" class="graf graf--p graf-after--p graf--trailing">From the onion architecture, we know the database is on the outer layer and should not be called by any object, but with ORM, we can easily develop the ORM as an entity into the inner layer of the onion architecture, and it even contains a lot of business logic. This is difficult to test and difficult to maintain, and is the worst situation of all.</p></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@lazypro" class="p-author h-card">Chunting Wu</a> on <a href="https://medium.com/p/6a21fccb5e6b"><time class="dt-published" datetime="2023-09-11T01:55:29.083Z">September 11, 2023</time></a>.</p><p><a href="https://medium.com/@lazypro/when-to-consider-clean-architecture-a-practical-guide-6a21fccb5e6b" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on October 21, 2024.</p></footer></article></body></html>