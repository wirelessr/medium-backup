<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Playing PyFlink from Scratch</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Playing PyFlink from Scratch</h1>
</header>
<section data-field="subtitle" class="p-summary">
Understanding PyFlink 1.15.2 on Kubernetes
</section>
<section data-field="body" class="e-content">
<section name="d03b" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="788d" id="788d" class="graf graf--h3 graf--leading graf--title">Playing PyFlink from Scratch</h3><h4 name="46f3" id="46f3" class="graf graf--h4 graf-after--h3 graf--subtitle">Understanding PyFlink 1.15.2 on Kubernetes</h4><figure name="9a13" id="9a13" class="graf graf--figure graf-after--h4"><img class="graf-image" data-image-id="0*rV-9-Gx4yDrGNssM" data-width="1000" data-height="750" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/0*rV-9-Gx4yDrGNssM"><figcaption class="imageCaption">Photo by <a href="https://unsplash.com/@kel_foto" data-href="https://unsplash.com/@kel_foto" class="markup--anchor markup--figure-anchor" rel="noopener" target="_blank">Hansjörg Keller</a> on <a href="https://unsplash.com/photos/xy6r-F-w70c" data-href="https://unsplash.com/photos/xy6r-F-w70c" class="markup--anchor markup--figure-anchor" rel="noopener" target="_blank">Unsplash</a></figcaption></figure><p name="4cf2" id="4cf2" class="graf graf--p graf-after--figure">I am trying to play with PyFlink recently, but there is not much information available on the Internet, and most of the information is a bit outdated. So I’ll document how I set up the environment and actually experiment with PyFlink.</p><p name="0bd3" id="0bd3" class="graf graf--p graf-after--p">Before starting, let’s set the experiment goals.</p><ol class="postList"><li name="b2d9" id="b2d9" class="graf graf--li graf-after--p">To run PyFlink instead of Flink, because I can’t code in JAVA.</li><li name="888c" id="888c" class="graf graf--li graf-after--li">To run on K8s, not docker or standalone.</li><li name="cd97" id="cd97" class="graf graf--li graf-after--li">Use the latest version of Flink, 1.15.2.</li></ol><p name="7cc5" id="7cc5" class="graf graf--p graf-after--li">I briefly describe the entire experimental process.</p><ol class="postList"><li name="5a4e" id="5a4e" class="graf graf--li graf-after--p">Create a K8s cluster.</li><li name="4be4" id="4be4" class="graf graf--li graf-after--li">Deploy PyFlink cluster.</li><li name="7249" id="7249" class="graf graf--li graf-after--li">Upload the job from the local machine.</li><li name="2715" id="2715" class="graf graf--li graf-after--li">Check the job status in the dashboard.</li></ol><p name="ed69" id="ed69" class="graf graf--p graf-after--li">Now, I believe you all understand the experimental process, so let’s start preparing the preconditions.</p><ul class="postList"><li name="e7a5" id="e7a5" class="graf graf--li graf-after--p">Do not use M1 chips. <a href="https://issues.apache.org/jira/browse/FLINK-25188" data-href="https://issues.apache.org/jira/browse/FLINK-25188" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">The current stable version 1.15.2 does not support M1 chips</a>, so installing PyFlink on M1 would be suffering.</li><li name="76d1" id="76d1" class="graf graf--li graf-after--li">JAVA 11</li><li name="98ac" id="98ac" class="graf graf--li graf-after--li">Python 3.6–3.8</li></ul><p name="6ade" id="6ade" class="graf graf--p graf-after--li">Once all is ready, let’s get started!</p><h3 name="f61d" id="f61d" class="graf graf--h3 graf-after--p">Create a K8s cluster</h3><p name="4a94" id="4a94" class="graf graf--p graf-after--h3">My personal preference is to use <a href="https://k3s.io/" data-href="https://k3s.io/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">K3s</a> to create clusters rather than minikube.</p><p name="db76" id="db76" class="graf graf--p graf-after--p">There are several reasons.</p><ol class="postList"><li name="b70a" id="b70a" class="graf graf--li graf-after--p">It is easier to share the environment. My experimental environment is on EC2, so anyone who knows the location can use it.</li><li name="d9f9" id="d9f9" class="graf graf--li graf-after--li">It is more resource efficient. minikube has high system requirements, while K3s itself is designed for IoT devices and is relatively resource efficient.</li><li name="d5d3" id="d5d3" class="graf graf--li graf-after--li">K3s is a regular K8s, there are no special features.</li></ol><p name="7e0e" id="7e0e" class="graf graf--p graf-after--li">After setting up the cluster according to the <a href="https://docs.k3s.io/quick-start" data-href="https://docs.k3s.io/quick-start" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">official document</a>, some extra settings are required.</p><p name="bb51" id="bb51" class="graf graf--p graf-after--p">Create a namespace.</p><ul class="postList"><li name="a395" id="a395" class="graf graf--li graf-after--p"><code class="markup--code markup--li-code">kubectl create ns flink</code></li></ul><p name="3d17" id="3d17" class="graf graf--p graf-after--li">Create a service account.</p><ul class="postList"><li name="b1c7" id="b1c7" class="graf graf--li graf-after--p"><code class="markup--code markup--li-code">kubectl create serviceaccount flink -n flink</code></li></ul><p name="3474" id="3474" class="graf graf--p graf-after--li">Grant authorization for the service account.</p><ul class="postList"><li name="0551" id="0551" class="graf graf--li graf-after--p"><code class="markup--code markup--li-code">kubectl create clusterrolebinding flink-role-bind --clusterrole=edit --serviceaccount=flink:flink</code></li></ul><h3 name="7ff2" id="7ff2" class="graf graf--h3 graf-after--li">Build a PyFlink cluster</h3><p name="3a45" id="3a45" class="graf graf--p graf-after--h3">To build a PyFlink cluster we need to prepare the container image to support PyFlink first as follows.</p><p name="cceb" id="cceb" class="graf graf--p graf-after--p"><a href="https://hub.docker.com/r/wirelessr/pyflink" data-href="https://hub.docker.com/r/wirelessr/pyflink" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">https://hub.docker.com/r/wirelessr/pyflink</a></p><p name="2208" id="2208" class="graf graf--p graf-after--p">The <code class="markup--code markup--p-code">Dockerfile</code> to build the container is also available in Dockerhub.</p><p name="40a3" id="40a3" class="graf graf--p graf-after--p">Next, download the latest stable version of flink artifact locally.</p><p name="bef8" id="bef8" class="graf graf--p graf-after--p"><a href="https://www.apache.org/dyn/closer.lua/flink/flink-1.15.2/flink-1.15.2-bin-scala_2.12.tgz" data-href="https://www.apache.org/dyn/closer.lua/flink/flink-1.15.2/flink-1.15.2-bin-scala_2.12.tgz" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">https://www.apache.org/dyn/closer.lua/flink/flink-1.15.2/flink-1.15.2-bin-scala_2.12.tgz</a></p><p name="9beb" id="9beb" class="graf graf--p graf-after--p">After decompression we have to add <a href="https://stackoverflow.com/questions/68761409/jcapemkeyconverter-is-provided-by-bouncycastle-an-optional-dependency-to-use-s" data-href="https://stackoverflow.com/questions/68761409/jcapemkeyconverter-is-provided-by-bouncycastle-an-optional-dependency-to-use-s" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">some fat jar that is required</a> but not packaged into it.</p><p name="cf82" id="cf82" class="graf graf--p graf-after--p">Download bcprov-jdk15on and bcpkix-jdk15on jar files at</p><ul class="postList"><li name="ecb6" id="ecb6" class="graf graf--li graf-after--p"><a href="https://mvnrepository.com/artifact/org.bouncycastle/bcprov-jdk15on" data-href="https://mvnrepository.com/artifact/org.bouncycastle/bcprov-jdk15on" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">https://mvnrepository.com/artifact/org.bouncycastle/bcprov-jdk15on</a></li><li name="29dc" id="29dc" class="graf graf--li graf-after--li"><a href="https://mvnrepository.com/artifact/org.bouncycastle/bcpkix-jdk15on" data-href="https://mvnrepository.com/artifact/org.bouncycastle/bcpkix-jdk15on" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">https://mvnrepository.com/artifact/org.bouncycastle/bcpkix-jdk15on</a></li></ul><p name="027a" id="027a" class="graf graf--p graf-after--li">Then move them to the folder</p><blockquote name="dbf2" id="dbf2" class="graf graf--blockquote graf-after--p"><em class="markup--em markup--blockquote-em">./flink-1.15.2/lib</em></blockquote><p name="92d5" id="92d5" class="graf graf--p graf-after--blockquote">When everything is ready, we can run the PyFlink cluster on K8s.</p><pre name="bc1f" id="bc1f" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">./bin/kubernetes-session.sh \<br> -Dkubernetes.namespace=flink \<br> -Dkubernetes.jobmanager.service-account=flink \<br> -Dkubernetes.rest-service.exposed.type=NodePort \<br> -Dkubernetes.cluster-id=flink-cluster \<br> -Dkubernetes.jobmanager.cpu=0.2 \<br> -Djobmanager.memory.process.size=1024m \<br> -Dresourcemanager.taskmanager-timeout=3600000 \<br> -Dkubernetes.taskmanager.cpu=0.2 \<br> -Dtaskmanager.memory.process.size=1024m \<br> -Dtaskmanager.numberOfTaskSlots=1 \<br> -Dkubernetes.container.image=wirelessr/pyflink:1.15.2-scala_2.12-python_3.7</code></pre><p name="c497" id="c497" class="graf graf--p graf-after--pre">There are two key points noteworthy.</p><ol class="postList"><li name="8f05" id="8f05" class="graf graf--li graf-after--p"><code class="markup--code markup--li-code">rest-service.exposed.type=NodePort</code>. In order to allow users to access the PyFlink cluster, and to simplify the experiment process, we choose to use <code class="markup--code markup--li-code">NodePort</code> as the external interface.</li><li name="275b" id="275b" class="graf graf--li graf-after--li">We must specify the <code class="markup--code markup--li-code">container.image</code> that can support PyFlink, in this case, the <a href="https://hub.docker.com/r/wirelessr/pyflink" data-href="https://hub.docker.com/r/wirelessr/pyflink" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">Dockerhub</a> mentioned earlier.</li></ol><p name="90cc" id="90cc" class="graf graf--p graf-after--li">By using <code class="markup--code markup--p-code">kubectl get svc -n flink</code> we can know which port the dashboard (flink-cluster-rest) is running on. This dashboard location will also be the entry point for the jobs we want to submit later.</p><h3 name="4f65" id="4f65" class="graf graf--h3 graf-after--p">Submit a job</h3><p name="f5e0" id="f5e0" class="graf graf--p graf-after--h3">Most of the Flink examples will use <code class="markup--code markup--p-code">examples/batch/WordCount.jar</code> as the first Hello World.</p><p name="e64c" id="e64c" class="graf graf--p graf-after--p">So we can also use this Jar file to test whether Flink can run correctly.</p><pre name="082b" id="082b" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">./bin/flink run \<br>  -m ${flink-cluster-rest}:${port} \<br>  examples/batch/WordCount.jar</code></pre><p name="9162" id="9162" class="graf graf--p graf-after--pre">After submitting, we can check the result in the dashboard, normally, it will be executed successfully. But this example is JAVA-based, so we’ll proceed with a Python-based example to verify PyFlink.</p><p name="1357" id="1357" class="graf graf--p graf-after--p">Before we start, we need to install the PyFlink package locally.</p><blockquote name="b55f" id="b55f" class="graf graf--blockquote graf-after--p"><em class="markup--em markup--blockquote-em">pip3 install apache-flink==1.15.2</em></blockquote><p name="7688" id="7688" class="graf graf--p graf-after--blockquote">If we are not using M1 chip, this command should install successfully without any problems.</p><p name="02fe" id="02fe" class="graf graf--p graf-after--p">Same as the WordCount example, Python also has a corresponding WordCount example in <code class="markup--code markup--p-code">examples/python/table/word_count.py</code>.</p><p name="f1fa" id="f1fa" class="graf graf--p graf-after--p">However, the Python example needs to be modified a bit to work properly. Find this comment line：</p><blockquote name="3cc9" id="3cc9" class="graf graf--blockquote graf-after--p"><em class="markup--em markup--blockquote-em">remove .wait if submitting to a remote cluster</em></blockquote><p name="ef10" id="ef10" class="graf graf--p graf-after--blockquote">Follow the instructions to remove the <code class="markup--code markup--p-code">.wait</code> above, and then we try to submit the Python job.</p><pre name="747d" id="747d" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">./bin/flink run \<br>  -m ${flink-cluster-rest}:${port} \<br>  -py ./examples/python/table/word_count.py</code></pre><p name="a278" id="a278" class="graf graf--p graf-after--pre">Returning to the dashboard should show the job is also performing properly.</p><h3 name="8d38" id="8d38" class="graf graf--h3 graf-after--p">Conclusion</h3><p name="8275" id="8275" class="graf graf--p graf-after--h3">There is very little information about PyFLink, both in terms of environment installation and coding reference, so I hope this article will be helpful to you.</p><p name="210e" id="210e" class="graf graf--p graf-after--p graf--trailing">However, this article does not explain the details of Flink cluster and how to develop PyFlink in detail, I’ll leave those details for a future article.</p></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@lazypro" class="p-author h-card">Chunting Wu</a> on <a href="https://medium.com/p/65c18908c366"><time class="dt-published" datetime="2022-10-17T07:31:29.372Z">October 17, 2022</time></a>.</p><p><a href="https://medium.com/@lazypro/playing-pyflink-from-scratch-65c18908c366" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on October 21, 2024.</p></footer></article></body></html>