<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Make any Website Authenticated</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Make any Website Authenticated</h1>
</header>
<section data-field="subtitle" class="p-summary">
A practical example of authentication via Google
</section>
<section data-field="body" class="e-content">
<section name="7893" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="50a4" id="50a4" class="graf graf--h3 graf--leading graf--title">Make any Website Authenticated</h3><h4 name="901c" id="901c" class="graf graf--h4 graf-after--h3 graf--subtitle">A practical example of authentication via Google</h4><figure name="4fbc" id="4fbc" class="graf graf--figure graf-after--h4"><img class="graf-image" data-image-id="0*LKmjdue4WOogzdXj.jpg" data-width="1771" data-height="1180" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/0*LKmjdue4WOogzdXj.jpg"><figcaption class="imageCaption">Photo by <a href="https://unsplash.com/@markusspiske" data-href="https://unsplash.com/@markusspiske" class="markup--anchor markup--figure-anchor" rel="noopener" target="_blank">Markus Spiske</a> on <a href="https://unsplash.com/photos/6pflEeSzGUo" data-href="https://unsplash.com/photos/6pflEeSzGUo" class="markup--anchor markup--figure-anchor" rel="noopener" target="_blank">Unsplash</a></figcaption></figure><p name="15f2" id="15f2" class="graf graf--p graf-after--figure">Authentication is always an important topic, basically, any website needs authentication function. Traditionally, we need to maintain our own database, frontend, backend and middleware to achieve complete authentication. But thanks to OAuth, we now have many easy options, such as using Google accounts for authentication.</p><p name="0ec8" id="0ec8" class="graf graf--p graf-after--p">In this article, we would like to introduce a way to make any website have Google authentication without any modification.</p><p name="eec8" id="eec8" class="graf graf--p graf-after--p">Why is there a need for this? Sometimes we can easily deploy a tool to the cloud, but we don’t want the tool to be available for public access, so we want to add authentication to it. However, we don’t want to modify the tool’s code, so we’re attempting to find a more efficient way to do this.</p><p name="dfda" id="dfda" class="graf graf--p graf-after--p">For example, <a href="https://flink.apache.org/" data-href="https://flink.apache.org/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Apache Flink</a> is a powerful and easy to develop streaming framework that provides a fully functional web portal. Nevertheless, the web portal has no authentication mechanism, so anyone who can access it can upload jobs.</p><p name="cc1b" id="cc1b" class="graf graf--p graf-after--p">The <a href="https://nightlies.apache.org/flink/flink-docs-release-1.16/docs/deployment/security/security-ssl/#external--rest-connectivity" data-href="https://nightlies.apache.org/flink/flink-docs-release-1.16/docs/deployment/security/security-ssl/#external--rest-connectivity" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">official documentation</a> recommends several approaches to mitigate this downside, but those approaches are too lightweight, on the other hand, to provide a full authentication mechanism, Flink supports Kerberos integration which is too heavy. Therefore, we need a plugin that makes it easy for a website to support common authentication.</p><h3 name="c1a2" id="c1a2" class="graf graf--h3 graf-after--p">Solution Concept</h3><figure name="e623" id="e623" class="graf graf--figure graf-after--h3"><img class="graf-image" data-image-id="1*hvOn2InPBQV2hoqYyE3_dA.png" data-width="670" data-height="326" src="https://cdn-images-1.medium.com/max/800/1*hvOn2InPBQV2hoqYyE3_dA.png"></figure><p name="a99d" id="a99d" class="graf graf--p graf-after--figure">From the above diagram, we can find out a user does not access the service directly, but through a Proxy, which verifies and determines whether to allow access.</p><p name="16f4" id="16f4" class="graf graf--p graf-after--p">Therefore, we do not need to modify the code of the service, we just need to plug a Proxy in front to achieve our goal.</p><p name="c10a" id="c10a" class="graf graf--p graf-after--p">In fact, there are many Proxies that provide this function, in this article we choose the most common one <a href="https://oauth2-proxy.github.io/oauth2-proxy/docs/configuration/overview" data-href="https://oauth2-proxy.github.io/oauth2-proxy/docs/configuration/overview" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">OAuth2 Proxy</a>, and use Google OAuth as an example.</p><h3 name="e8e3" id="e8e3" class="graf graf--h3 graf-after--p">Setup Step by Step</h3><p name="f116" id="f116" class="graf graf--p graf-after--h3">First, we need to go to <a href="https://console.cloud.google.com/" data-href="https://console.cloud.google.com/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Google Cloud Console</a> to create a new project, the process is not difficult, just fill it out.</p><p name="35c3" id="35c3" class="graf graf--p graf-after--p">Next, navigate to <code class="markup--code markup--p-code">Credentials</code> under <code class="markup--code markup--p-code">API &amp; Service</code> and create a new credential. There is only one field that needs careful consideration, <code class="markup--code markup--p-code">Redirect URL</code>, here fill in the <code class="markup--code markup--p-code">http://localhost:4180/oauth2/callback</code> that is needed for the example.</p><p name="9a0a" id="9a0a" class="graf graf--p graf-after--p">Please remember the <code class="markup--code markup--p-code">Client ID</code> and <code class="markup--code markup--p-code">Client Secret</code> after you finish creating, we will need them later.</p><p name="a5b4" id="a5b4" class="graf graf--p graf-after--p">Now, let’s use a simple web app as an example, which is the <code class="markup--code markup--p-code">hello-app</code> provided by Google.</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="yaml" name="58ad" id="58ad" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-attr">version:</span> <span class="hljs-string">&#x27;3&#x27;</span><br /><br /><span class="hljs-attr">services:</span><br />  <span class="hljs-attr">hello-world:</span><br />    <span class="hljs-attr">image:</span> <span class="hljs-string">gcr.io/google-samples/hello-app:1.0</span><br />    <span class="hljs-attr">ports:</span><br />      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;8080:8080&quot;</span></span></pre><p name="d8a8" id="d8a8" class="graf graf--p graf-after--pre">Running this <code class="markup--code markup--p-code">docker-compose.yml</code> should start hello world, and you can see the corresponding message at <code class="markup--code markup--p-code">http://localhost:8080</code>. At this point, the web app is working without authentication.</p><p name="847a" id="847a" class="graf graf--p graf-after--p">Let’s add a Proxy to implement authentication.</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="yaml" name="e203" id="e203" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-attr">services:</span><br />  <span class="hljs-attr">oauth2-proxy:</span><br />    <span class="hljs-attr">ports:</span><br />      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;4180:4180&quot;</span><br />    <span class="hljs-attr">image:</span> <span class="hljs-string">bitnami/oauth2-proxy:7.3.0</span><br />    <span class="hljs-attr">command:</span><br />      <span class="hljs-bullet">-</span> <span class="hljs-string">--http-address</span><br />      <span class="hljs-bullet">-</span> <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span><span class="hljs-string">:4180</span><br />    <span class="hljs-attr">environment:</span><br />      <span class="hljs-attr">OAUTH2_PROXY_UPSTREAMS:</span> <span class="hljs-string">&quot;http://hello-world:8080/&quot;</span><br />      <span class="hljs-attr">OAUTH2_PROXY_CLIENT_ID:</span> <span class="hljs-string">&lt;YOUR_CLIENT_ID&gt;</span><br />      <span class="hljs-attr">OAUTH2_PROXY_CLIENT_SECRET:</span> <span class="hljs-string">&lt;YOUR_CLIENT_SECRET&gt;</span><br />      <span class="hljs-attr">OAUTH2_PROXY_COOKIE_SECRET:</span> <span class="hljs-string">&lt;A_STORNG_SALT&gt;</span><br />      <span class="hljs-attr">OAUTH2_PROXY_HTTPS_REDIRECT:</span> <span class="hljs-string">&quot;false&quot;</span><br />      <span class="hljs-attr">OAUTH2_PROXY_EMAIL_DOMAINS:</span> <span class="hljs-string">&quot;*&quot;</span><br />      <span class="hljs-attr">OAUTH2_PROXY_PROVIDER:</span> <span class="hljs-string">&quot;google&quot;</span><br />      <span class="hljs-attr">OAUTH2_PROXY_REDIRECT_URL:</span> <span class="hljs-string">&quot;http://localhost:4180/oauth2/callback&quot;</span><br />    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span></span></pre><p name="107a" id="107a" class="graf graf--p graf-after--pre">There are three fields to fill in this example, including the <code class="markup--code markup--p-code">Client ID</code> and <code class="markup--code markup--p-code">Client Secret</code> just mentioned, as well as the secret needed by a proxy, if there is no special need, then just generate it. I am using a Python script to generate, in fact, there are many ways, choose the one you are familiar with.</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="python" name="4dfe" id="4dfe" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">import</span> secrets<br /><span class="hljs-built_in">print</span>(secrets.token_hex(<span class="hljs-number">16</span>))</span></pre><p name="2c96" id="2c96" class="graf graf--p graf-after--pre">Just launch this docker compose directly after completion. You can find that if you access <code class="markup--code markup--p-code">http://localhost:4180</code>, you will be redirected to Google Authentication. Once authenticated, you can see the original hello world result.</p><p name="716c" id="716c" class="graf graf--p graf-after--p">Finally, we can close the originally opened 8080 port. Here is a complete <code class="markup--code markup--p-code">docker-compose.yml</code>, copy and paste it directly with minor modifications and it will work.</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="yaml" name="e3ff" id="e3ff" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-attr">version:</span> <span class="hljs-string">&#x27;3&#x27;</span><br /><br /><span class="hljs-attr">services:</span><br />  <span class="hljs-attr">hello-world:</span><br />    <span class="hljs-attr">image:</span> <span class="hljs-string">gcr.io/google-samples/hello-app:1.0</span><br />    <span class="hljs-attr">ports:</span><br />      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;8080&quot;</span><br />  <span class="hljs-attr">oauth2-proxy:</span><br />    <span class="hljs-attr">ports:</span><br />      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;4180:4180&quot;</span><br />    <span class="hljs-attr">image:</span> <span class="hljs-string">bitnami/oauth2-proxy:7.3.0</span><br />    <span class="hljs-attr">command:</span><br />      <span class="hljs-bullet">-</span> <span class="hljs-string">--http-address</span><br />      <span class="hljs-bullet">-</span> <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span><span class="hljs-string">:4180</span><br />    <span class="hljs-attr">environment:</span><br />      <span class="hljs-attr">OAUTH2_PROXY_UPSTREAMS:</span> <span class="hljs-string">&quot;http://hello-world:8080/&quot;</span><br />      <span class="hljs-attr">OAUTH2_PROXY_CLIENT_ID:</span> <span class="hljs-string">&lt;YOUR_CLIENT_ID&gt;</span><br />      <span class="hljs-attr">OAUTH2_PROXY_CLIENT_SECRET:</span> <span class="hljs-string">&lt;YOUR_CLIENT_SECRET&gt;</span><br />      <span class="hljs-attr">OAUTH2_PROXY_COOKIE_SECRET:</span> <span class="hljs-string">&lt;A_STORNG_SALT&gt;</span><br />      <span class="hljs-attr">OAUTH2_PROXY_HTTPS_REDIRECT:</span> <span class="hljs-string">&quot;false&quot;</span><br />      <span class="hljs-attr">OAUTH2_PROXY_EMAIL_DOMAINS:</span> <span class="hljs-string">&quot;*&quot;</span><br />      <span class="hljs-attr">OAUTH2_PROXY_PROVIDER:</span> <span class="hljs-string">&quot;google&quot;</span><br />      <span class="hljs-attr">OAUTH2_PROXY_REDIRECT_URL:</span> <span class="hljs-string">&quot;http://localhost:4180/oauth2/callback&quot;</span><br />    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span></span></pre><p name="b785" id="b785" class="graf graf--p graf-after--pre">If the function is not working properly, it is possible that Google’s OAuth client needs start time, wait for it a little.</p><h3 name="9c47" id="9c47" class="graf graf--h3 graf-after--p">Conclusion</h3><p name="bfd7" id="bfd7" class="graf graf--p graf-after--h3">This article is a real example of what can be done, and it is quite straightforward.</p><p name="20e0" id="20e0" class="graf graf--p graf-after--p">Nevertheless, it is important to accomplish our goal to add authentication to any web app. For this example, we chose Google OAuth as the easiest to implement, but actually OAuth Proxy supports a lot of IDPs, and there is a complete list in the <a href="https://oauth2-proxy.github.io/oauth2-proxy/docs/configuration/oauth_provider" data-href="https://oauth2-proxy.github.io/oauth2-proxy/docs/configuration/oauth_provider" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">official document</a>.</p><p name="57b7" id="57b7" class="graf graf--p graf-after--p graf--trailing">To understand this article, you don’t even need any background knowledge of OAuth, just follow the steps. Enjoy.</p></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@lazypro" class="p-author h-card">Chunting Wu</a> on <a href="https://medium.com/p/7ec69fd63c84"><time class="dt-published" datetime="2023-03-20T01:52:03.227Z">March 20, 2023</time></a>.</p><p><a href="https://medium.com/@lazypro/make-any-website-authenticated-7ec69fd63c84" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on October 21, 2024.</p></footer></article></body></html>