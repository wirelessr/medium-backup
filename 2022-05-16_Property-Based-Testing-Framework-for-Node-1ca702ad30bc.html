<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Property-Based Testing Framework for Node</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Property-Based Testing Framework for Node</h1>
</header>
<section data-field="subtitle" class="p-summary">
Understand how fast-check works with a practical example
</section>
<section data-field="body" class="e-content">
<section name="e4ec" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="4724" id="4724" class="graf graf--h3 graf--leading graf--title">Property-Based Testing Framework for Node</h3><h4 name="a671" id="a671" class="graf graf--h4 graf-after--h3 graf--subtitle">Understand how fast-check works with a practical example</h4><figure name="5e46" id="5e46" class="graf graf--figure graf-after--h4"><img class="graf-image" data-image-id="0*0vIaQCIhozBRhN0q" data-width="5184" data-height="3456" data-unsplash-photo-id="3_Xwxya43hE" src="https://cdn-images-1.medium.com/max/800/0*0vIaQCIhozBRhN0q"><figcaption class="imageCaption">Photo by <a href="https://unsplash.com/@pinewatt?utm_source=medium&amp;utm_medium=referral" data-href="https://unsplash.com/@pinewatt?utm_source=medium&amp;utm_medium=referral" class="markup--anchor markup--figure-anchor" rel="photo-creator noopener" target="_blank">pine watt</a> on <a href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" data-href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" class="markup--anchor markup--figure-anchor" rel="photo-source noopener" target="_blank">Unsplash</a></figcaption></figure><p name="34f1" id="34f1" class="graf graf--p graf-after--figure"><em class="markup--em markup--p-em">The Pragmatic Programmer</em> introduces a method of testing called property-based testing, in which an example is given in Python, using the framework <a href="https://hypothesis.readthedocs.io/en/latest/" data-href="https://hypothesis.readthedocs.io/en/latest/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">hypothesis</a>.</p><p name="1df0" id="1df0" class="graf graf--p graf-after--p">The usage of the hypothesis is very intuitive and simple and presents the concept of property-based testing perfectly. So I also wanted to find an equivalent alternative in Node. Two of them have high star ratings on Github, <a href="https://github.com/jsverify/jsverify" data-href="https://github.com/jsverify/jsverify" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">JSVerify</a> with 1.6K stars and <a href="https://github.com/dubzzz/fast-" data-href="https://github.com/dubzzz/fast-" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">fast-check</a> with 2.8K stars. So I took some time to study <code class="markup--code markup--p-code">fast-check</code> a little bit and try to get closer to my daily work.</p><p name="d4f8" id="d4f8" class="graf graf--p graf-after--p">This article is a recap, and a simple example to document the experience.</p><h3 name="552e" id="552e" class="graf graf--h3 graf-after--p">Why Property-Based Testing?</h3><p name="d962" id="d962" class="graf graf--p graf-after--h3">Before providing examples, let’s explain why we use property-based tests. In fact, I don’t like the term property-based. In my words, “extremely high-volume” testing.</p><p name="7d70" id="7d70" class="graf graf--p graf-after--p">We all know that Test Pyramid is as follows.</p><figure name="3f63" id="3f63" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="0*nUdAvOUH7bhp9HG7.png" data-width="300" data-height="233" src="https://cdn-images-1.medium.com/max/800/0*nUdAvOUH7bhp9HG7.png"><figcaption class="imageCaption">Test Pyramid</figcaption></figure><p name="6c23" id="6c23" class="graf graf--p graf-after--figure">And in my previous article, I mentioned <a href="https://medium.com/interviewnoodle/whats-difference-between-unit-test-and-integration-test-aae6ef13220" data-href="https://medium.com/interviewnoodle/whats-difference-between-unit-test-and-integration-test-aae6ef13220" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">what’s the difference between unit tests and integration tests</a>. At the lower levels of the pyramid, more test cases are required.</p><p name="0bab" id="0bab" class="graf graf--p graf-after--p">Even so, it is difficult to generate a large number of test cases. We usually write corresponding tests based on known conditions or product specifications, sometimes we may remember to write boundary tests (sometimes not), and sometimes we may rely on simple random verification of functionality, e.g. <a href="https://fakerjs.dev/guide/" data-href="https://fakerjs.dev/guide/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">faker</a>.</p><p name="04b5" id="04b5" class="graf graf--p graf-after--p">However, in general, even if we try hard to come up with test cases, we cannot cover all scenarios, and we call this testing method example-based testing. This is because the test cases we come up with are basically extended from a certain example and cannot cover all the unknown contexts nor can we test all the boundary conditions.</p><p name="b55a" id="b55a" class="graf graf--p graf-after--p">At this point, we would like to have a framework automatically generate enough scenarios (reasonable scenarios or not) to verify the code we write, and the test cases we write only need to ensure their “properties” are correct. This is the origin of property-based testing.</p><h3 name="cc94" id="cc94" class="graf graf--h3 graf-after--p">Nevertheless</h3><blockquote name="24e7" id="24e7" class="graf graf--blockquote graf-after--h3"><em class="markup--em markup--blockquote-em">The reality is that integration testing is approximately the same as unit testing.</em></blockquote><p name="951c" id="951c" class="graf graf--p graf-after--blockquote">I have worked in many organizations, from large national enterprises to small startups. Whether I am a developer or a mentor, from past experience, unit testing is about as relevant as integration testing.</p><p name="7f5d" id="7f5d" class="graf graf--p graf-after--p">For most developers, it is not an easy task to properly divide unit testing and integration testing. To be able to split test cases entirely they need to have the skills of design patterns, dependency injection, dependency inversion, etc. to be able to do it well. Therefore, most test environments are based on a specific test environment, such as using <code class="markup--code markup--p-code">docker-compose</code> to generate a one-time database and test data and test on it.</p><p name="8409" id="8409" class="graf graf--p graf-after--p">The documents of <code class="markup--code markup--p-code">fast-check</code> is written based on the standard of unit test, and it seems that only the verification boolean is provided, that is, <code class="markup--code markup--p-code">fc.assert</code>, so I took some time to research to write a test case close to daily use.</p><p name="dafc" id="dafc" class="graf graf--p graf-after--p">Generally, I need several abilities.</p><ol class="postList"><li name="5be9" id="5be9" class="graf graf--li graf-after--p">Be able to test async/await.</li><li name="ab69" id="ab69" class="graf graf--li graf-after--li">Be able to verify more contexts, such as <code class="markup--code markup--li-code">assertEqual</code>.</li></ol><h3 name="4aba" id="4aba" class="graf graf--h3 graf-after--li">fast-check Introduction</h3><p name="eeb9" id="eeb9" class="graf graf--p graf-after--h3">Before we start writing test cases, let’s have a look at the basic usage of <code class="markup--code markup--p-code">fast-check</code>.</p><p name="6c27" id="6c27" class="graf graf--p graf-after--p">First, let’s introduce the structure of <code class="markup--code markup--p-code">fast-check</code>.</p><ul class="postList"><li name="2b6c" id="2b6c" class="graf graf--li graf-after--p"><code class="markup--code markup--li-code">Assertion (fc.assert)</code></li><li name="bf69" id="bf69" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code">Properties (fc.property or fc.asyncProperty)</code></li></ul><p name="168c" id="168c" class="graf graf--p graf-after--li">The function of <code class="markup--code markup--p-code">fc.assert</code> is to verify that all the tests automatically generated by the properties are correct. The properties are needed to describe two important blocks.</p><ul class="postList"><li name="8aec" id="8aec" class="graf graf--li graf-after--p">Runner</li><li name="79fd" id="79fd" class="graf graf--li graf-after--li">Arbitraries</li></ul><p name="590e" id="590e" class="graf graf--p graf-after--li">Runner is the context to be tested, i.e., the target. On the other hand, the arbitraries are the input parameters of the target, which are automatically generated by the properties, and all we have to do is to provide rules for them, e.g., only integers.</p><p name="b13f" id="b13f" class="graf graf--p graf-after--p">The following is a simple example.</p><pre name="5146" id="5146" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">fc.assert(<br>  fc.property(fc.integer(), fc.integer(), (i, j) =&gt; {<br>    return i + j === add(i, j);<br>  })<br>);</code></pre><p name="fc02" id="fc02" class="graf graf--p graf-after--pre">The two <code class="markup--code markup--p-code">fc.integer()</code> are arbitraries, and the later anonymous function is the runner, which takes two arguments <code class="markup--code markup--p-code">i</code> and <code class="markup--code markup--p-code">j</code>, corresponding to the previous arbitraries. We want to verify whether the function <code class="markup--code markup--p-code">add</code> really sums the two arguments correctly, so the result of <code class="markup--code markup--p-code">add</code> should be consistent with <code class="markup--code markup--p-code">+</code>.</p><p name="b8e3" id="b8e3" class="graf graf--p graf-after--p">Let’s review the two requirements we just mentioned.</p><ol class="postList"><li name="37e6" id="37e6" class="graf graf--li graf-after--p"><code class="markup--code markup--li-code">fast-check</code> is able to test async/await, runner can be a promise, and <code class="markup--code markup--li-code">fc.assert</code> itself is also a promise.</li><li name="afaf" id="afaf" class="graf graf--li graf-after--li">Although our test target is <code class="markup--code markup--li-code">add</code>, but a good integration with some conditions in the runner can make not only the effect of boolean.</li></ol><h3 name="200e" id="200e" class="graf graf--h3 graf-after--li">fast-check Examples</h3><p name="55ee" id="55ee" class="graf graf--p graf-after--h3">Now let’s come to a more practical example. Suppose I have a database table with money for each user.</p><figure name="7330" id="7330" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*Nque5NtvSpJSqQImeh-G0w.png" data-width="374" data-height="408" src="https://cdn-images-1.medium.com/max/800/1*Nque5NtvSpJSqQImeh-G0w.png"></figure><p name="7f4f" id="7f4f" class="graf graf--p graf-after--figure">There is a function <code class="markup--code markup--p-code">async function getMoney(limit)</code> which will sort money in ascending order and also determine how much money to return based on the parameters.</p><p name="f379" id="f379" class="graf graf--p graf-after--p">Now we want to test this black box.</p><figure name="871c" id="871c" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/wirelessr/cb7e073d15342843dcadf97be89a2f51.js"></script></figure><p name="f862" id="f862" class="graf graf--p graf-after--figure">Let me explain in brief.</p><ol class="postList"><li name="7232" id="7232" class="graf graf--li graf-after--p">Just simply verify the function really works, there is no use of <code class="markup--code markup--li-code">fast-check</code>.</li><li name="45fc" id="45fc" class="graf graf--li graf-after--li">Given an arbitrary integer, the length of the return result should be between 0 and 10, because we only created ten records in <code class="markup--code markup--li-code">before</code>.</li><li name="5491" id="5491" class="graf graf--li graf-after--li">Given a range of integers, the length of the return should be equal to the given length.</li><li name="36a5" id="36a5" class="graf graf--li graf-after--li">Verify the order of the whole array is indeed ascending. From this runner can be seen, even very complex conditions can be verified, but be careful not to make bugs in the test case resulting in the need for a test case of the test case.</li></ol><p name="d6c1" id="d6c1" class="graf graf--p graf-after--li">If a problem is detected, <code class="markup--code markup--p-code">fast-check</code> will also tell you what kind of arbitraries it uses to detect the problem. For example,</p><blockquote name="7acc" id="7acc" class="graf graf--blockquote graf-after--p"><em class="markup--em markup--blockquote-em">Counterexample: [-1234567890]</em></blockquote><p name="32d3" id="32d3" class="graf graf--p graf-after--blockquote">This means the test case failed when <code class="markup--code markup--p-code">i = -1234567890</code>. It is possible the negative number is not handled correctly or the “large” negative number is not handled correctly. This is the time to write a real unit test (or integration test) and verify -1234567890 so that such a failed case can be used as a regression test afterward.</p><h3 name="72f3" id="72f3" class="graf graf--h3 graf-after--p">Conclusion</h3><p name="08b5" id="08b5" class="graf graf--p graf-after--h3">Ideally, when testing database behavior like this, we would use techniques such as dependency injection to isolate the physical database in order to improve testing performance. But as I said earlier, it is not easy to properly separate code from external dependencies depending on the experience and skill of the developer.</p><p name="00b2" id="00b2" class="graf graf--p graf-after--p">So in many organizations, we still see that most of the test cases have to rely on the physical database for testing. But I have to say this is incorrect.</p><p name="27b3" id="27b3" class="graf graf--p graf-after--p graf--trailing">In this article, I explain the usage of <code class="markup--code markup--p-code">fast-check</code> through a real-life example and how it is close to practice. Nevertheless, I hope we don’t have to face this again, at least after reading <a href="https://medium.com/interviewnoodle/whats-difference-between-unit-test-and-integration-test-aae6ef13220" data-href="https://medium.com/interviewnoodle/whats-difference-between-unit-test-and-integration-test-aae6ef13220" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">my previous article</a>, let’s try to turn over those unreasonable test cases.</p></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@lazypro" class="p-author h-card">Chunting Wu</a> on <a href="https://medium.com/p/1ca702ad30bc"><time class="dt-published" datetime="2022-05-16T01:42:07.001Z">May 16, 2022</time></a>.</p><p><a href="https://medium.com/@lazypro/property-based-testing-framework-for-node-1ca702ad30bc" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on October 21, 2024.</p></footer></article></body></html>