<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Playing Window Function in Postgres</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Playing Window Function in Postgres</h1>
</header>
<section data-field="subtitle" class="p-summary">
Demonstrating some common practices of SQL Window Function
</section>
<section data-field="body" class="e-content">
<section name="97c4" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="32bb" id="32bb" class="graf graf--h3 graf--leading graf--title">Playing Window Function in Postgres</h3><h4 name="d849" id="d849" class="graf graf--h4 graf-after--h3 graf--subtitle">Demonstrating some common practices of SQL Window Function</h4><figure name="8d03" id="8d03" class="graf graf--figure graf-after--h4"><img class="graf-image" data-image-id="0*Qz0v2k7uXZjAYaZ1" data-width="1000" data-height="681" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/0*Qz0v2k7uXZjAYaZ1"><figcaption class="imageCaption">Photo by <a href="https://unsplash.com/@mooo3721" data-href="https://unsplash.com/@mooo3721" class="markup--anchor markup--figure-anchor" rel="noopener" target="_blank">R Mo</a> on <a href="https://unsplash.com/photos/w-_iZqdviAo" data-href="https://unsplash.com/photos/w-_iZqdviAo" class="markup--anchor markup--figure-anchor" rel="noopener" target="_blank">Unsplash</a></figcaption></figure><p name="eb75" id="eb75" class="graf graf--p graf-after--figure">When doing ETL, we always write data into the database one batch at a time, which contains the snapshot of each batch. these snapshots are basically historical data and may contain a lot of duplicates, so how do we find the data we need in these batches?</p><p name="301b" id="301b" class="graf graf--p graf-after--p">This article will use a simple scenario to describe some of our common processing methods, mainly <a href="https://www.postgresql.org/docs/current/tutorial-window.html" data-href="https://www.postgresql.org/docs/current/tutorial-window.html" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">window function</a>.</p><h3 name="0d33" id="0d33" class="graf graf--h3 graf-after--p">User Scenario</h3><p name="7a99" id="7a99" class="graf graf--p graf-after--h3">Suppose a company uses a BPM system to manage employee changes and salary changes, then a simple BPM system will usually have two tables with the details of the employee and the salary of each person as follows.</p><figure name="b064" id="b064" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*QMUMLc5QuFJs2vuR0IcgFQ.png" data-width="546" data-height="654" src="https://cdn-images-1.medium.com/max/800/1*QMUMLc5QuFJs2vuR0IcgFQ.png"></figure><p name="b54e" id="b54e" class="graf graf--p graf-after--figure">When working with relational databases, we usually normalize the data, i.e., we plan the tables in terms of requirement dimensions and keep only the necessary fields, which are related to each other by foreign keys.</p><p name="80f3" id="80f3" class="graf graf--p graf-after--p">But in the data analysis context, we often need a fact table, which means everything is aggregated together. An example of a fact table for salary analysis might look like the following.</p><figure name="2742" id="2742" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*_hPyMFxp41l67vOM0n6imA.png" data-width="480" data-height="328" src="https://cdn-images-1.medium.com/max/800/1*_hPyMFxp41l67vOM0n6imA.png"></figure><p name="8e5a" id="8e5a" class="graf graf--p graf-after--figure">The common practice in aggregation is batch processing ETL, where each time the required columns are fetched from the employee details table and salary table and saved for later analysis such as salary increase trend. The fact table after the ETL aggregation is as follows.</p><figure name="04ef" id="04ef" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="0*hLFP6AMHFWqcml1N.png" data-width="1496" data-height="590" src="https://cdn-images-1.medium.com/max/800/0*hLFP6AMHFWqcml1N.png"></figure><p name="c85c" id="c85c" class="graf graf--p graf-after--figure">This is an ETL for batch processing in days, and the two tables will be aggregated every day, so there will be <code class="markup--code markup--p-code">job_process_id</code> for batch processing and <code class="markup--code markup--p-code">create_time</code> for data creation.</p><p name="6446" id="6446" class="graf graf--p graf-after--p">Here is the SQL used in the example.</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="sql" name="c4d0" id="c4d0" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> &quot;public&quot;.&quot;cdc_test&quot; (<br />	&quot;id&quot; serial <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br />	&quot;create_time&quot; <span class="hljs-type">DATE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br />	&quot;job_process_id&quot; <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br />	&quot;empid&quot; <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br />	&quot;ename&quot; <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br />	&quot;sal&quot; <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br />	<span class="hljs-keyword">PRIMARY</span> KEY (&quot;id&quot;)<br />);<br /><br /><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> &quot;public&quot;.&quot;cdc_test&quot; (&quot;id&quot;, &quot;create_time&quot;, &quot;job_process_id&quot;, &quot;empid&quot;, &quot;ename&quot;, &quot;sal&quot;) <span class="hljs-keyword">VALUES</span><br />(<span class="hljs-number">1</span>, <span class="hljs-string">&#x27;2018-12-10&#x27;</span>, <span class="hljs-number">111</span>, <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;Ravi&#x27;</span>, <span class="hljs-number">3000</span>),<br />(<span class="hljs-number">2</span>, <span class="hljs-string">&#x27;2018-12-10&#x27;</span>, <span class="hljs-number">111</span>, <span class="hljs-number">2</span>, <span class="hljs-string">&#x27;Raj&#x27;</span>, <span class="hljs-number">4000</span>),<br />(<span class="hljs-number">3</span>, <span class="hljs-string">&#x27;2018-12-10&#x27;</span>, <span class="hljs-number">111</span>, <span class="hljs-number">3</span>, <span class="hljs-string">&#x27;Ram&#x27;</span>, <span class="hljs-number">5000</span>),<br />(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;2018-12-11&#x27;</span>, <span class="hljs-number">112</span>, <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;Ravi&#x27;</span>, <span class="hljs-number">3000</span>),<br />(<span class="hljs-number">5</span>, <span class="hljs-string">&#x27;2018-12-11&#x27;</span>, <span class="hljs-number">112</span>, <span class="hljs-number">2</span>, <span class="hljs-string">&#x27;Raj&#x27;</span>, <span class="hljs-number">4000</span>),<br />(<span class="hljs-number">6</span>, <span class="hljs-string">&#x27;2018-12-11&#x27;</span>, <span class="hljs-number">112</span>, <span class="hljs-number">3</span>, <span class="hljs-string">&#x27;Ram&#x27;</span>, <span class="hljs-number">5000</span>),<br />(<span class="hljs-number">7</span>, <span class="hljs-string">&#x27;2018-12-11&#x27;</span>, <span class="hljs-number">112</span>, <span class="hljs-number">4</span>, <span class="hljs-string">&#x27;Srini&#x27;</span>, <span class="hljs-number">6500</span>),<br />(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;2018-12-12&#x27;</span>, <span class="hljs-number">113</span>, <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;Ravi&#x27;</span>, <span class="hljs-number">7000</span>),<br />(<span class="hljs-number">9</span>, <span class="hljs-string">&#x27;2018-12-12&#x27;</span>, <span class="hljs-number">113</span>, <span class="hljs-number">2</span>, <span class="hljs-string">&#x27;Raj&#x27;</span>, <span class="hljs-number">4000</span>),<br />(<span class="hljs-number">10</span>, <span class="hljs-string">&#x27;2018-12-12&#x27;</span>, <span class="hljs-number">113</span>, <span class="hljs-number">3</span>, <span class="hljs-string">&#x27;Ram&#x27;</span>, <span class="hljs-number">5000</span>),<br />(<span class="hljs-number">11</span>, <span class="hljs-string">&#x27;2018-12-12&#x27;</span>, <span class="hljs-number">113</span>, <span class="hljs-number">4</span>, <span class="hljs-string">&#x27;Srini&#x27;</span>, <span class="hljs-number">6500</span>);</span></pre><p name="62ed" id="62ed" class="graf graf--p graf-after--pre">In this example there are two state changes.</p><ol class="postList"><li name="648c" id="648c" class="graf graf--li graf-after--p">Srini was on board on 2018-12-11.</li><li name="71b4" id="71b4" class="graf graf--li graf-after--li">Ravi got a pay raise on 2018-12-12.</li></ol><h3 name="e448" id="e448" class="graf graf--h3 graf-after--li">Get the latest state</h3><p name="3b6e" id="3b6e" class="graf graf--p graf-after--h3">As we can see from the above figure, the fact table generated by ETL will contain a lot of duplicate data, if we need to know the current state and to exclude duplicates, how to do? This is where the window function comes into play.</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="sql" name="01ef" id="01ef" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">SELECT</span><br />  t.<span class="hljs-operator">*</span><br /><span class="hljs-keyword">FROM</span> (<br />  <span class="hljs-keyword">SELECT</span><br />    cdc_test.<span class="hljs-operator">*</span>,<br />    (<span class="hljs-built_in">ROW_NUMBER</span>() <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> empid,<br />      ename <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> create_time <span class="hljs-keyword">DESC</span>)) <span class="hljs-keyword">AS</span> seqnum<br />  <span class="hljs-keyword">FROM</span><br />    cdc_test) t<br /><span class="hljs-keyword">WHERE</span><br />  t.seqnum <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;</span></pre><p name="981d" id="981d" class="graf graf--p graf-after--pre">By using <code class="markup--code markup--p-code">PARTITION BY</code> to lock the fixed columns <code class="markup--code markup--p-code">(empid, ename)</code>, and sorting the time in reverse order, we can know the first one will be the latest state.</p><p name="b9f5" id="b9f5" class="graf graf--p graf-after--p">The result is as follows.</p><figure name="a3cf" id="a3cf" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*zyjNnsBEAks_-J5tXgns8w.png" data-width="1112" data-height="394" src="https://cdn-images-1.medium.com/max/800/1*zyjNnsBEAks_-J5tXgns8w.png"></figure><h3 name="d4fb" id="d4fb" class="graf graf--h3 graf-after--figure">Get changes per salary</h3><p name="0090" id="0090" class="graf graf--p graf-after--h3">With the latest state, we usually still want to know about every salary change. We can still achieve our goal through the window function.</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="sql" name="b6cf" id="b6cf" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">SELECT</span><br />  t.<span class="hljs-operator">*</span><br /><span class="hljs-keyword">FROM</span> (<br />  <span class="hljs-keyword">SELECT</span><br />    cdc_test.<span class="hljs-operator">*</span>,<br />    (<span class="hljs-built_in">ROW_NUMBER</span>() <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> empid,<br />      ename,<br />      sal <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> create_time)) <span class="hljs-keyword">AS</span> seqnum<br />  <span class="hljs-keyword">FROM</span><br />    cdc_test) t<br /><span class="hljs-keyword">WHERE</span><br />  t.seqnum <span class="hljs-operator">=</span> <span class="hljs-number">1</span></span></pre><p name="81c5" id="81c5" class="graf graf--p graf-after--pre">This time, we <code class="markup--code markup--p-code">PARTITION BY</code> to lock the target is <code class="markup--code markup--p-code">(empid, ename, sal)</code>, because we want to treat the same three columns as the same group, then once the <code class="markup--code markup--p-code">sal</code> changes will create a new group.</p><figure name="5d77" id="5d77" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="0*LQjrIjHXJzm3ZX96.png" data-width="1000" data-height="396" src="https://cdn-images-1.medium.com/max/800/0*LQjrIjHXJzm3ZX96.png"></figure><p name="af54" id="af54" class="graf graf--p graf-after--figure">From the results, we can see that Ravi got one raise, from 3000 to 7000.</p><h3 name="93e8" id="93e8" class="graf graf--h3 graf-after--p">Get changes per salary and include the result before salary increase</h3><p name="2822" id="2822" class="graf graf--p graf-after--h3">In the above two examples, we only use <code class="markup--code markup--p-code">ROW_NUMBER()</code>, but in fact there are many other functions available in the window function.</p><p name="c81b" id="c81b" class="graf graf--p graf-after--p">This time, we not only want to get the salary change, but also want the query result to include the column before the salary increase, so we can use <code class="markup--code markup--p-code">LAG()</code>.</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="sql" name="6a0c" id="6a0c" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">SELECT</span><br />  t.<span class="hljs-operator">*</span><br /><span class="hljs-keyword">FROM</span> (<br />  <span class="hljs-keyword">SELECT</span><br />    cdc_test.<span class="hljs-operator">*</span>,<br />    (<span class="hljs-built_in">LAG</span>(sal) <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> empid,<br />      ename <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> create_time)) <span class="hljs-keyword">AS</span> prev_sal<br />  <span class="hljs-keyword">FROM</span><br />    cdc_test) t<br /><span class="hljs-keyword">WHERE</span><br />  prev_sal <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span><br />  <span class="hljs-keyword">OR</span> prev_sal <span class="hljs-operator">&lt;&gt;</span> sal;</span></pre><p name="ef85" id="ef85" class="graf graf--p graf-after--pre">Similar to the above, except that another window function is used and the <code class="markup--code markup--p-code">WHERE</code> clause is changed.</p><figure name="dd71" id="dd71" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="0*5rPkg0n2qAQnr8dp.png" data-width="910" data-height="316" src="https://cdn-images-1.medium.com/max/800/0*5rPkg0n2qAQnr8dp.png"></figure><p name="3bfe" id="3bfe" class="graf graf--p graf-after--figure">Now we can see a new column.</p><h3 name="3494" id="3494" class="graf graf--h3 graf-after--p">Reference</h3><div name="8902" id="8902" class="graf graf--mixtapeEmbed graf-after--h3 graf--trailing"><a href="https://stackoverflow.com/questions/53729837/how-to-select-only-incremental-records-in-big-query" data-href="https://stackoverflow.com/questions/53729837/how-to-select-only-incremental-records-in-big-query" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://stackoverflow.com/questions/53729837/how-to-select-only-incremental-records-in-big-query"><strong class="markup--strong markup--mixtapeEmbed-strong">How to select only incremental records in BIG QUERY</strong><br><em class="markup--em markup--mixtapeEmbed-em">I have a data in my database like as follows and i am expecting the result like Can anyone please help me how to write…</em>stackoverflow.com</a><a href="https://stackoverflow.com/questions/53729837/how-to-select-only-incremental-records-in-big-query" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="62b71d9a7427ff821436b67627896277" data-thumbnail-img-id="0*aLN91r-UifbBfuCX" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*aLN91r-UifbBfuCX);"></a></div></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@lazypro" class="p-author h-card">Chunting Wu</a> on <a href="https://medium.com/p/1eb7bb781f8e"><time class="dt-published" datetime="2022-12-26T01:51:26.638Z">December 26, 2022</time></a>.</p><p><a href="https://medium.com/@lazypro/playing-window-function-in-postgres-1eb7bb781f8e" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on October 21, 2024.</p></footer></article></body></html>