<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Building Ruby on Rails from Scratch, Day 2</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Building Ruby on Rails from Scratch, Day 2</h1>
</header>
<section data-field="subtitle" class="p-summary">
More Things about Relations, Tests, etc.
</section>
<section data-field="body" class="e-content">
<section name="f746" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="b634" id="b634" class="graf graf--h3 graf--leading graf--title">Building Ruby on Rails from Scratch, Day 2</h3><h4 name="535e" id="535e" class="graf graf--h4 graf-after--h3 graf--subtitle">More Things about Relations, Tests, etc.</h4><figure name="9e1c" id="9e1c" class="graf graf--figure graf-after--h4"><img class="graf-image" data-image-id="0*-I3bHrLgkPkby-ty.png" data-width="500" data-height="700" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/0*-I3bHrLgkPkby-ty.png"><figcaption class="imageCaption"><a href="https://dev.to/rly" data-href="https://dev.to/rly" class="markup--anchor markup--figure-anchor" rel="nofollow noopener" target="_blank">https://dev.to/rly</a></figcaption></figure><ul class="postList"><li name="6454" id="6454" class="graf graf--li graf-after--figure">Day 1: <a href="https://lazypro.medium.com/building-ruby-on-rails-from-scratch-b855584ff4f8" data-href="https://lazypro.medium.com/building-ruby-on-rails-from-scratch-b855584ff4f8" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">From Nothing to Something</a></li><li name="7837" id="7837" class="graf graf--li graf-after--li">Day 2: <a href="https://lazypro.medium.com/building-ruby-on-rails-from-scratch-day-2-d609fce59811" data-href="https://lazypro.medium.com/building-ruby-on-rails-from-scratch-day-2-d609fce59811" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">More Things about Relations, Tests, etc.</a></li><li name="e40c" id="e40c" class="graf graf--li graf-after--li">Day 3: <a href="https://lazypro.medium.com/ae31c975bf32" data-href="https://lazypro.medium.com/ae31c975bf32" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">My Thoughts on Ruby</a></li></ul><p name="a544" id="a544" class="graf graf--p graf-after--li">In the previous article, our application has almost finished building the user model. In this article, we will proceed to build a model of each user’s corresponding store, i.e., one-to-one mapping.</p><p name="efa3" id="efa3" class="graf graf--p graf-after--p">In addition, user-related unit tests will be created to practice <code class="markup--code markup--p-code">RSpec</code>.</p><p name="a3c1" id="a3c1" class="graf graf--p graf-after--p">So, let’s get started.</p><h3 name="f624" id="f624" class="graf graf--h3 graf-after--p">Establish a one-to-one mapping</h3><p name="dbf7" id="dbf7" class="graf graf--p graf-after--h3">First of all, the same store model is created by <code class="markup--code markup--p-code">scaffold</code>, but the difference is that the store must be assigned to a user at the end.</p><blockquote name="623b" id="623b" class="graf graf--blockquote graf-after--p"><em class="markup--em markup--blockquote-em">$ bin/rails generate scaffold shop name user:belongs_to</em></blockquote><p name="0210" id="0210" class="graf graf--p graf-after--blockquote">In this way, the controller and routes of stores will be created. But this is not enough, because it is a one-to-one mapping relationship, so we must also modify the original user model, as follows <a href="https://github.com/wirelessr/Hello-RoR/commit/d34ff4f28f4c3b7175d66ad5d52cb7494359df72" data-href="https://github.com/wirelessr/Hello-RoR/commit/d34ff4f28f4c3b7175d66ad5d52cb7494359df72" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Github commit</a>.</p><p name="afd2" id="afd2" class="graf graf--p graf-after--p">It has to be specified as <code class="markup--code markup--p-code">has_one</code> in <code class="markup--code markup--p-code">app/models/user.rb</code>, otherwise it becomes a one-to-many mapping. In addition, Rails has an inborn problem when dealing with mapping relationships, which is <em class="markup--em markup--p-em">N + 1 queries</em>.</p><p name="ff2c" id="ff2c" class="graf graf--p graf-after--p">In this example, <em class="markup--em markup--p-em">N + 1 queries</em> is not a serious impact because it is a one-to-one mapping, but if it is a one-to-many mapping, then it will have a performance impact. The solution is also very simple, and is provided in the above mentioned commit.</p><p name="e1a0" id="e1a0" class="graf graf--p graf-after--p">Change the original <code class="markup--code markup--p-code">Shop.all</code> generated by <code class="markup--code markup--p-code">scaffold</code> to <code class="markup--code markup--p-code">Shop.includes(:user)</code>. Then the user model will not be searched for one record at a time, but will be listed at once.</p><h3 name="d310" id="d310" class="graf graf--h3 graf-after--p">Create nested routing</h3><p name="78cf" id="78cf" class="graf graf--p graf-after--h3">Since users and stores have an ownership relationship, we can also create a nested route to get the stores under users.</p><p name="f48e" id="f48e" class="graf graf--p graf-after--p">Just modify <code class="markup--code markup--p-code">config/routes.rb</code> to add the store resources under the user’s resources, as shown in the <a href="https://github.com/wirelessr/Hello-RoR/commit/59f5bfa40abcf7d6e93f623a568f53b6b1a73ac5" data-href="https://github.com/wirelessr/Hello-RoR/commit/59f5bfa40abcf7d6e93f623a568f53b6b1a73ac5" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Github commit</a>.</p><h3 name="6a25" id="6a25" class="graf graf--h3 graf-after--p">Setup unit tests</h3><p name="fa0f" id="fa0f" class="graf graf--p graf-after--h3">Nowadays the most popular test framework on Rails is <code class="markup--code markup--p-code">RSpec</code>, so I also did some exercises with <code class="markup--code markup--p-code">RSpec</code>.</p><p name="25ae" id="25ae" class="graf graf--p graf-after--p">The installation is very simple, just add a new line <code class="markup--code markup--p-code">gem &#39;rspec-rails&#39;</code> at <code class="markup--code markup--p-code">Gemfile</code>, and it is recommended to add it under the <code class="markup--code markup--p-code">development</code> and <code class="markup--code markup--p-code">test</code> groups. Next, install and configure.</p><blockquote name="0f79" id="0f79" class="graf graf--blockquote graf-after--p"><em class="markup--em markup--blockquote-em">$ bundle install<br>$ bin/rails generate rspec:install</em></blockquote><p name="af23" id="af23" class="graf graf--p graf-after--blockquote">We have generated various models by <code class="markup--code markup--p-code">scaffold</code> before, so we continue to generate corresponding tests by <code class="markup--code markup--p-code">scaffold</code> as well. Let’s take the user model as an example.</p><blockquote name="a603" id="a603" class="graf graf--blockquote graf-after--p"><em class="markup--em markup--blockquote-em">$ bin/rails generate rspec:scaffold user</em></blockquote><p name="ce87" id="ce87" class="graf graf--p graf-after--blockquote">Normally, all test cases created can be executed directly at this time.</p><blockquote name="f37b" id="f37b" class="graf graf--blockquote graf-after--p"><em class="markup--em markup--blockquote-em">$ rspec</em></blockquote><p name="fda9" id="fda9" class="graf graf--p graf-after--blockquote">However, on the <code class="markup--code markup--p-code">M1</code> system, we will encounter problems.</p><p name="cc45" id="cc45" class="graf graf--p graf-after--p">Rails bootstrap puts <code class="markup--code markup--p-code">selenium-webdriver</code> in by default, but <code class="markup--code markup--p-code">selenium-webdriver</code> is compiled for the x86 platform, so an error occurs when running <code class="markup--code markup--p-code">rspec</code>.</p><p name="038a" id="038a" class="graf graf--p graf-after--p">I didn’t have to run end-to-end tests, so I just unplugged the irrelevant dependencies from <code class="markup--code markup--p-code">Gemfile</code> and <code class="markup--code markup--p-code">rspec</code> ran correctly.</p><p name="ea70" id="ea70" class="graf graf--p graf-after--p">The result of this section is as follows, <a href="https://github.com/wirelessr/Hello-RoR/commit/2f71665acfac2d6765b374e1301b2045f8377cf6" data-href="https://github.com/wirelessr/Hello-RoR/commit/2f71665acfac2d6765b374e1301b2045f8377cf6" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Github commit</a>. From the commit, you can see that <code class="markup--code markup--p-code">scaffold</code> generates many user model related test cases.</p><h3 name="b8b3" id="b8b3" class="graf graf--h3 graf-after--p">Start testing</h3><p name="270a" id="270a" class="graf graf--p graf-after--h3">Let’s test the model first. There are several constraints that must be tested.</p><ol class="postList"><li name="6c60" id="6c60" class="graf graf--li graf-after--p"><code class="markup--code markup--li-code">first_name</code> and <code class="markup--code markup--li-code">last_name</code> must have values.</li><li name="0f71" id="0f71" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code">gender</code> must be one of male, female and others.</li><li name="efb9" id="efb9" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code">age</code> must be a natural number.</li><li name="b9f1" id="b9f1" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code">address</code> field is an object and only the three keys <code class="markup--code markup--li-code">country</code>, <code class="markup--code markup--li-code">address_1</code> and <code class="markup--code markup--li-code">address_2</code> are allowed.</li></ol><p name="6b36" id="6b36" class="graf graf--p graf-after--li">The full test is listed in the link below.<br><a href="https://github.com/wirelessr/Hello-RoR/commit/55fca06899d60256345c9d5ec5f14a2aa51a8b3f" data-href="https://github.com/wirelessr/Hello-RoR/commit/55fca06899d60256345c9d5ec5f14a2aa51a8b3f" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">https://github.com/wirelessr/Hello-RoR/commit/55fca06899d60256345c9d5ec5f14a2aa51a8b3f</a></p><p name="6cb2" id="6cb2" class="graf graf--p graf-after--p">Then we proceeded to test the controller. Fortunately, <code class="markup--code markup--p-code">rspec:scaffold</code> already has the basic framework set up, so we just need to fill in the details.</p><p name="7b8f" id="7b8f" class="graf graf--p graf-after--p">The native test file is in <code class="markup--code markup--p-code">spec/requests/users_spec.rb</code>, and there are a few places where the <code class="markup--code markup--p-code">skip</code> function skips, and all we have to do is follow the instructions in <code class="markup--code markup--p-code">skip</code> to replace it with a legal or illegal user model.</p><p name="7fc9" id="7fc9" class="graf graf--p graf-after--p">The <a href="https://github.com/wirelessr/Hello-RoR/commit/bb50fed7e11a73d6ced7249e48197321d2240fe7" data-href="https://github.com/wirelessr/Hello-RoR/commit/bb50fed7e11a73d6ced7249e48197321d2240fe7" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Github commit</a> is attached.</p><h3 name="faf9" id="faf9" class="graf graf--h3 graf-after--p">My reflections on RSpec</h3><p name="6995" id="6995" class="graf graf--p graf-after--h3">In fact, the syntax of RSpec is very familiar to me because of my experience in writing <code class="markup--code markup--p-code">mocha</code> on top of Node. Whether it’s <code class="markup--code markup--p-code">describe</code> or <code class="markup--code markup--p-code">it</code> or even <code class="markup--code markup--p-code">expect</code>, it’s all similar, so I didn’t encounter any difficulties.</p><p name="fb7e" id="fb7e" class="graf graf--p graf-after--p">In the process of practicing, I referred to an RSpec best practice document. I used to write <code class="markup--code markup--p-code">mocha</code> very casually, without referring to any rules, so this document also provides good advice. In the future, whether it’s Ruby’s RSpec or Node’s <code class="markup--code markup--p-code">mocha</code>, it should be able to be written in a more beautiful way.</p><p name="c314" id="c314" class="graf graf--p graf-after--p">The reference link is directly attached, <a href="https://www.betterspecs.org/" data-href="https://www.betterspecs.org/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Better Specs</a>.</p><h3 name="564e" id="564e" class="graf graf--h3 graf-after--p">My reflections on Ruby</h3><p name="64ca" id="64ca" class="graf graf--p graf-after--h3">After practicing Rails for a few days, I didn’t encounter too many difficulties because I could see more or less the shadow of other languages in Ruby, among which I think the closest should be Python, and many concepts are shared.</p><p name="d1a7" id="d1a7" class="graf graf--p graf-after--p">However, there are some Ruby-specific behaviors that took me a while to study.</p><p name="ce82" id="ce82" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em">Symbol</em></strong></p><p name="10fe" id="10fe" class="graf graf--p graf-after--p">It is common to see variables starting with a colon in Ruby, such as <code class="markup--code markup--p-code">:abc</code>, which actually refers to the string <code class="markup--code markup--p-code">abc</code>. Unlike a string, however, this string is immutable.</p><p name="fe57" id="fe57" class="graf graf--p graf-after--p">This has the advantage that the comparison between symbols does not need to be done character by character, but can be done directly to the memory address, so it is faster than a string comparison.</p><p name="6863" id="6863" class="graf graf--p graf-after--p">This concept is also found in Python, which places common words and numbers at fixed memory addresses to speed up references. In the Python example below, the addresses of <code class="markup--code markup--p-code">a</code> and <code class="markup--code markup--p-code">b</code> are the same, and both come from the object of <code class="markup--code markup--p-code">1</code>, which has been predefined.</p><pre name="20c0" id="20c0" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">&gt;&gt;&gt; a = 1<br>&gt;&gt;&gt; b = 1<br>&gt;&gt;&gt; id(a)<br>5777693336<br>&gt;&gt;&gt; id(b)<br>5777693336</code></pre><p name="cb5b" id="cb5b" class="graf graf--p graf-after--pre"><strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em">Parentheses can be omitted</em></strong></p><p name="2959" id="2959" class="graf graf--p graf-after--p">In Ruby, both parentheses and braces can be omitted, so a bunch of behaviors appear that are difficult for first-time users to understand. For example.</p><ul class="postList"><li name="b3ec" id="b3ec" class="graf graf--li graf-after--p">When formatting a string, <code class="markup--code markup--li-code">&quot;#{abc} is good&quot;</code>, it’s hard to know if the <code class="markup--code markup--li-code">abc</code> refers to a variable or the function <code class="markup--code markup--li-code">abc()</code> is called.</li><li name="6a5c" id="6a5c" class="graf graf--li graf-after--li">When calling the function <code class="markup--code markup--li-code">foo a=&gt; 1, b =&gt; 2, c =&gt; 3</code> how many arguments does <code class="markup--code markup--li-code">foo</code> have when written in this way? The answer is that we don’t know, we need to see the signature of <code class="markup--code markup--li-code">foo</code> to know.</li></ul><p name="49b9" id="49b9" class="graf graf--p graf-after--li">There are also various variants, such as this omission of parentheses really made me suffer a lot in reading other people’s code.</p><p name="f781" id="f781" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em">Class definition</em></strong></p><p name="54dc" id="54dc" class="graf graf--p graf-after--p">The definition of an attribute within an object is <code class="markup--code markup--p-code">@</code>, so <code class="markup--code markup--p-code">@abc</code> is equivalent to Python’s <code class="markup--code markup--p-code">self.abc</code>.</p><p name="30fc" id="30fc" class="graf graf--p graf-after--p">But if we define a function using <code class="markup--code markup--p-code">self</code>, it means something completely different, <code class="markup--code markup--p-code">def self.bar()</code>, which in Python terms means <code class="markup--code markup--p-code">bar</code> is a <code class="markup--code markup--p-code">classmethod</code>.</p><p name="164d" id="164d" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em">Poor performance</em></strong></p><p name="6313" id="6313" class="graf graf--p graf-after--p">In CPython, the performance of the entire application is limited by the implementation of GIL, and even with multi-threaded execution, all operations must still be performed sequentially.</p><p name="376f" id="376f" class="graf graf--p graf-after--p">This is also true for Ruby, which also has GIL, and usually uses pre-fork in order to fully utilize the machine’s resources, and the Gunicorn used in Python is actually derived from Ruby’s Unicorn.</p><h3 name="a1c1" id="a1c1" class="graf graf--h3 graf-after--p">Afterword</h3><p name="94cb" id="94cb" class="graf graf--p graf-after--h3">Although the process of practicing Rails went smoothly, I actually encountered a lot of difficulties while doing the code review, both related to the Ruby features I mentioned in the previous section, and from the Rails features.</p><p name="2f9a" id="2f9a" class="graf graf--p graf-after--p graf--trailing">I’ll describe my thoughts on Ruby on Rails in the next article, which should be the last in this series.</p></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@lazypro" class="p-author h-card">Chunting Wu</a> on <a href="https://medium.com/p/d609fce59811"><time class="dt-published" datetime="2022-07-25T01:37:22.383Z">July 25, 2022</time></a>.</p><p><a href="https://medium.com/@lazypro/building-ruby-on-rails-from-scratch-day-2-d609fce59811" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on October 21, 2024.</p></footer></article></body></html>