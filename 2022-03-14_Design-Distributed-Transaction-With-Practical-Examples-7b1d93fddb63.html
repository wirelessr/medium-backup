<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Design Distributed Transaction With Practical Examples</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Design Distributed Transaction With Practical Examples</h1>
</header>
<section data-field="subtitle" class="p-summary">
What a design review actually looks like
</section>
<section data-field="body" class="e-content">
<section name="a061" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="9aa1" id="9aa1" class="graf graf--h3 graf--leading graf--title">Design Distributed Transaction With Practical Examples</h3><h4 name="ac25" id="ac25" class="graf graf--h4 graf-after--h3 graf--subtitle">What a design review actually looks like</h4><figure name="8dd9" id="8dd9" class="graf graf--figure graf-after--h4"><img class="graf-image" data-image-id="0*AFKbOvu2LxfS5Dlq" data-width="5184" data-height="3456" data-unsplash-photo-id="FlPc9_VocJ4" src="https://cdn-images-1.medium.com/max/800/0*AFKbOvu2LxfS5Dlq"><figcaption class="imageCaption">Photo by <a href="https://unsplash.com/@johnschno?utm_source=medium&amp;utm_medium=referral" data-href="https://unsplash.com/@johnschno?utm_source=medium&amp;utm_medium=referral" class="markup--anchor markup--figure-anchor" rel="photo-creator noopener" target="_blank">John Schnobrich</a> on <a href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" data-href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" class="markup--anchor markup--figure-anchor" rel="photo-source noopener" target="_blank">Unsplash</a></figcaption></figure><p name="418a" id="418a" class="graf graf--p graf-after--figure">Last time, we have discussed, <a href="https://betterprogramming.pub/how-to-prepare-a-design-review-like-an-expert-85d2ab85d7f5" data-href="https://betterprogramming.pub/how-to-prepare-a-design-review-like-an-expert-85d2ab85d7f5" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">how to prepare a design review like an expert</a>. There are three items that should be prepared:</p><ul class="postList"><li name="f5d5" id="f5d5" class="graf graf--li graf-after--p">C4 model</li><li name="b851" id="b851" class="graf graf--li graf-after--li">User stories and use cases</li><li name="bfd6" id="bfd6" class="graf graf--li graf-after--li">Design decisions</li></ul><p name="4612" id="4612" class="graf graf--p graf-after--li">In this article, I will use a practical example to show you what is a design review looks like. Some discussions with too many details will be skipped, and only demonstrate the critical designs.</p><h3 name="ca80" id="ca80" class="graf graf--h3 graf-after--p">User Stories</h3><p name="721c" id="721c" class="graf graf--p graf-after--h3">First, we are going to define the user story. Like the previous article mentioned, user story aligns with the context perspective in C4 model. Therefore, we write down the user stories clearly.</p><p name="ef21" id="ef21" class="graf graf--p graf-after--p">This time we are going to do the function of giving gifts. And, the whole story is as follows.</p><ul class="postList"><li name="65e4" id="65e4" class="graf graf--li graf-after--p">A User can decide how many of the same gifts they want to give to others at a time.</li><li name="3f0c" id="3f0c" class="graf graf--li graf-after--li">As long as the user has enough money, then there is no limit to the number of people giving gifts.</li><li name="a029" id="a029" class="graf graf--li graf-after--li">After finishing giving gifts, it must inform both sender and receivers that everything has been done.</li></ul><h3 name="99e3" id="99e3" class="graf graf--h3 graf-after--li">Use cases</h3><p name="c23d" id="c23d" class="graf graf--p graf-after--h3">The entire gift-giving scene is clearly described in the user story, however, there are some details that are not sufficiently described. For example,</p><ul class="postList"><li name="fbb0" id="fbb0" class="graf graf--li graf-after--p">If the user’s balance is not enough, then all gifts will fail and cannot be partially successful.</li><li name="b99d" id="b99d" class="graf graf--li graf-after--li">Finishing giving gifts represents all receivers have received the gift.</li><li name="1816" id="1816" class="graf graf--li graf-after--li">The content of the notification must contain sender, total amount of gifts and all receivers.</li><li name="7cc2" id="7cc2" class="graf graf--li graf-after--li">No matter how many people to give, the entire process should be finished in a few minutes.</li></ul><p name="420b" id="420b" class="graf graf--p graf-after--li">As we can see above, in the use cases, we added details that were not in the story, and presented the whole scene in more detail.</p><h3 name="21a4" id="21a4" class="graf graf--h3 graf-after--p">C4 Model</h3><p name="88d9" id="88d9" class="graf graf--p graf-after--h3">Now, we can draw the C4 model of the entire design.</p><h3 name="99d4" id="99d4" class="graf graf--h3 graf-after--p">Context</h3><figure name="0a02" id="0a02" class="graf graf--figure graf-after--h3"><img class="graf-image" data-image-id="1*WFOdotUY2mTKPaBZiGhM6Q.png" data-width="329" data-height="446" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/1*WFOdotUY2mTKPaBZiGhM6Q.png"><figcaption class="imageCaption">context diagram</figcaption></figure><p name="185b" id="185b" class="graf graf--p graf-after--figure">Based on the user story, we draw a context to describe the interaction between the user and the system. From the context, we know that there are several key points that must be fully discussed.</p><ol class="postList"><li name="387c" id="387c" class="graf graf--li graf-after--p">The line that contains the <code class="markup--code markup--li-code">gift</code></li><li name="1496" id="1496" class="graf graf--li graf-after--li">Behavior of the <code class="markup--code markup--li-code">Server</code> itself</li><li name="3d5d" id="3d5d" class="graf graf--li graf-after--li">The line containing the <code class="markup--code markup--li-code">notify</code></li></ol><p name="b066" id="b066" class="graf graf--p graf-after--li">You may ask how about the <code class="markup--code markup--p-code">notification service</code> and <code class="markup--code markup--p-code">receivers</code>. The answer is simple. That is a third party service, and we cannot control its behavior. Therefore, there is no need to discuss it in a design review on the topic of giving gifts. Of course, if there is any concern about the notification, we can hold another design review to dig in.</p><h3 name="3da1" id="3da1" class="graf graf--h3 graf-after--p">Container</h3><p name="16de" id="16de" class="graf graf--p graf-after--h3">Once we have the context, we start to dive into the three points listed above and expand them in the form of a container.</p><figure name="3c0c" id="3c0c" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*QREa2DjREx-ZIYZL_vdLjA.png" data-width="704" data-height="235" src="https://cdn-images-1.medium.com/max/800/1*QREa2DjREx-ZIYZL_vdLjA.png"><figcaption class="imageCaption">container diagram</figcaption></figure><p name="1b47" id="1b47" class="graf graf--p graf-after--figure">Finally we got this diagram, this is what it looks like when it is finished. There are many design decisions here, but in this section, I will only introduce the meaning of this diagram. As for the design decisions, we will leave the analysis in depth in the later sections.</p><ol class="postList"><li name="4576" id="4576" class="graf graf--li graf-after--p">Users send gift requests, including what to send and whom to send.</li><li name="1495" id="1495" class="graf graf--li graf-after--li">After receiving the request, <code class="markup--code markup--li-code">Server</code> first debits the user’s wallet and responds directly to <code class="markup--code markup--li-code">nak</code> if the balance is not enough, then divides the request into batches of fixed size and writes the batch information to the database. After that, the batch task is sent to the worker for execution asynchronously with the serial number of the transaction.</li><li name="9025" id="9025" class="graf graf--li graf-after--li">Although the process is not complete, the preparations have been done, so reply to the user <code class="markup--code markup--li-code">ack</code> to show that the whole process is in progress.</li><li name="1747" id="1747" class="graf graf--li graf-after--li">When the worker receives the command, it focuses on the batch task it is assigned, and when it finishes, it deducts the <code class="markup--code markup--li-code">counter</code> from the database. If the worker encounters any errors, just retry the task itself.</li><li name="2781" id="2781" class="graf graf--li graf-after--li">When the <code class="markup--code markup--li-code">counter</code> is found to be 0 after deducting the counter, which means everyone has finished the task, then the last worker will notify all the receivers.</li></ol><h3 name="22e7" id="22e7" class="graf graf--h3 graf-after--li">Component and Code</h3><p name="9288" id="9288" class="graf graf--p graf-after--h3">From the perspective of the container, the next steps are component and code, but these are already related to some implementation details, and each system faces different problems, so I won’t go into more detail here.</p><h3 name="e058" id="e058" class="graf graf--h3 graf-after--p">Design Decisions</h3><p name="1b77" id="1b77" class="graf graf--p graf-after--h3">We found many details in the container diagram. As I did in the previous article, we will use the <code class="markup--code markup--p-code">why do A instead of B</code> formula to ask a lot of questions.</p><ol class="postList"><li name="5ccc" id="5ccc" class="graf graf--li graf-after--p">Why sender and server communicate with each other in a semi-asynchronous way (between synchronous and asynchronous)?</li><li name="37bf" id="37bf" class="graf graf--li graf-after--li">Why is the server divided into an orchestration and workers?</li><li name="4f9c" id="4f9c" class="graf graf--li graf-after--li">Why orchestration and workers are completely asynchronous?</li><li name="d303" id="d303" class="graf graf--li graf-after--li">Why is the worker notifying the receivers?</li><li name="8031" id="8031" class="graf graf--li graf-after--li">Maybe you are able to consider some questions I have never listed.</li></ol><p name="7d3a" id="7d3a" class="graf graf--p graf-after--li">All of these questions should be told from the original architecture.</p><p name="1c4e" id="1c4e" class="graf graf--p graf-after--p">At the beginning, we have already the feature of giving a gift to a person. So, the simplest way is performing a for-loop to send all receivers through the one-to-one gift regardless of the receiver number.</p><p name="18d0" id="18d0" class="graf graf--p graf-after--p">This is fine when there are only a few receivers, but once the number of receivers starts to increase, performance will be a serious challenge. In our measurements, it takes about <code class="markup--code markup--p-code">100-200 ms</code> to deliver a person, not including notifications, which means that when the number of people reaches <code class="markup--code markup--p-code">10</code>, it will reach the second-magnitude. This is obviously unacceptable.</p><p name="1c44" id="1c44" class="graf graf--p graf-after--p">It seems that the batching is inevitable, so someone drew up the first architecture diagram.</p><figure name="7d00" id="7d00" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*lkjVYSjjwNEJgKtUhMU65g.png" data-width="507" data-height="349" src="https://cdn-images-1.medium.com/max/800/1*lkjVYSjjwNEJgKtUhMU65g.png"><figcaption class="imageCaption">first attempt</figcaption></figure><p name="9734" id="9734" class="graf graf--p graf-after--figure">From the diagram, we can find that the orchestration has already been appeared. However, the communication with the worker is still synchronized, and the notification will be sent only when all the tasks are done. It will not reply to the user until all the tasks are finished. This may seem to have significantly reduced the performance bottleneck, but it hasn’t gotten better at all.</p><p name="6d94" id="6d94" class="graf graf--p graf-after--p">Let’s do a simple math. Suppose we want to send gifts to 1000 people, how do we set the batch size and the number of workers?</p><p name="d1d3" id="d1d3" class="graf graf--p graf-after--p">To finish it in seconds, the maximum batch size is <code class="markup--code markup--p-code">10</code>, so <code class="markup--code markup--p-code">100</code> workers need to be generated at the same time to handle a gift request. This is a very strict challenge for the system, and it is not an easy task to generate <code class="markup--code markup--p-code">100</code> workers in an instant. Because of this, it is difficult to keep users waiting in a fully synchronized manner. So, what happens when it is completely asynchronized?</p><figure name="9397" id="9397" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*xvFJZLlgVPS_x_8rO5WicQ.png" data-width="708" data-height="84" src="https://cdn-images-1.medium.com/max/800/1*xvFJZLlgVPS_x_8rO5WicQ.png"><figcaption class="imageCaption">second attempt</figcaption></figure><p name="0109" id="0109" class="graf graf--p graf-after--figure">In the second attempt, we changed the orchestration to choreography, so that the user could get the response in a very quick time and the gift could be sent smoothly. But, is it really so?</p><p name="7189" id="7189" class="graf graf--p graf-after--p">What happens if the middle worker fails? The whole chain is broken, and the user may not feel it without notification. It is fine, but for the giver, the middle successful worker has already deducted the user’s money, but the notification is not sent. Moreover, back to the first point of the use cases, partial success is not allowed.</p><p name="b1ff" id="b1ff" class="graf graf--p graf-after--p">Choreography compared to orchestration will indeed have better performance and better scalability, but will get more complex workflow control. Therefore, in this use case, orchestration would be more appropriate.</p><p name="f7c7" id="f7c7" class="graf graf--p graf-after--p">So let’s implement full asynchronization through orchestration.</p><figure name="c1ea" id="c1ea" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*o3UlbgaffqqfhnWNL_5KoA.png" data-width="410" data-height="252" src="https://cdn-images-1.medium.com/max/800/1*o3UlbgaffqqfhnWNL_5KoA.png"><figcaption class="imageCaption">third attempt</figcaption></figure><p name="e211" id="e211" class="graf graf--p graf-after--figure">This architecture encounters two problems immediately.</p><ol class="postList"><li name="5091" id="5091" class="graf graf--li graf-after--p">Who should send the notification?</li><li name="aaac" id="aaac" class="graf graf--li graf-after--li">How to do if the money is not enough in the half way?</li></ol><p name="4b87" id="4b87" class="graf graf--p graf-after--li">The problem of sending notifications is well solved, as in the previous container view in the C4 model, has actually solved the problem of who to send notifications. Nevertheless, it is basically impossible to handle the error in the half way to a completely asynchronous architecture.</p><p name="abd8" id="abd8" class="graf graf--p graf-after--p">Due to this reason, we finally adopted a semi-asynchronous approach. First, the orchestration determines whether the balance is enough to send, and in order to avoid the racing condition, the money is deducted directly. So the worker only needs to handle sending the gift, not to deduct the money from the giver, not even to check the balance.</p><h3 name="dcc5" id="dcc5" class="graf graf--h3 graf-after--p">Error Handle and Disaster Recovery</h3><p name="9b1d" id="9b1d" class="graf graf--p graf-after--h3">Under the such architecture, there is a huge trouble.</p><blockquote name="3291" id="3291" class="graf graf--blockquote graf-after--p"><em class="markup--em markup--blockquote-em">How about the worker failed?</em></blockquote><p name="fe02" id="fe02" class="graf graf--p graf-after--blockquote">If it is occurred due to database congestion, it should be okay after just retrying several times. Otherwise, if there is a malfunction in the implementation, it cannot be resolved even though retry many times.</p><p name="59c0" id="59c0" class="graf graf--p graf-after--p">As a result, an additional monitoring system needs to exist to periodically check which asynchronous tasks have failed, and retry those that can be retried, or notify human intervention if they cannot recover by retries. The <a href="https://betterprogramming.pub/implement-event-driven-architecture-with-minimal-effort-182c3bbe5524" data-href="https://betterprogramming.pub/implement-event-driven-architecture-with-minimal-effort-182c3bbe5524" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">applicable solution</a> is in a previous article I have already introduced, so I won’t explain too much here.</p><h3 name="669c" id="669c" class="graf graf--h3 graf-after--p">Conclusion</h3><p name="d5a3" id="d5a3" class="graf graf--p graf-after--h3">To sum up, the system breaks down gift-giving into several steps.</p><ol class="postList"><li name="404d" id="404d" class="graf graf--li graf-after--p">The user sends the request synchronously and the balance is deducted in advance.</li><li name="7857" id="7857" class="graf graf--li graf-after--li">All processes of giving gifts are performed asynchronously.</li><li name="6fad" id="6fad" class="graf graf--li graf-after--li">The process of giving gifts can be consistent eventually, and the money deducted is equal to the money issued.</li></ol><p name="a018" id="a018" class="graf graf--p graf-after--li">In this article, we discuss challenges while designing a distributed system in a practical example.</p><ul class="postList"><li name="77ef" id="77ef" class="graf graf--li graf-after--p">Synchronous vs. Asynchronous</li><li name="8cf0" id="8cf0" class="graf graf--li graf-after--li">Orchestration vs. Choreography</li><li name="cf27" id="cf27" class="graf graf--li graf-after--li">Atomic vs. Eventual consistency</li></ul><p name="b3c5" id="b3c5" class="graf graf--p graf-after--li graf--trailing">In fact, those items are the trade-offs in a typical distributed transaction as well. These aspects can significantly affect the overall distributed transaction model. I have introduced distributed transactions in <a href="https://medium.com/interviewnoodle/distributed-transaction-introduction-1cd105c830a2" data-href="https://medium.com/interviewnoodle/distributed-transaction-introduction-1cd105c830a2" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">my previous article</a>. Next time, I’ll take a closer look at the challenges and issues faced when designing a distributed system.</p></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@lazypro" class="p-author h-card">Chunting Wu</a> on <a href="https://medium.com/p/7b1d93fddb63"><time class="dt-published" datetime="2022-03-14T00:55:15.486Z">March 14, 2022</time></a>.</p><p><a href="https://medium.com/@lazypro/design-distributed-transaction-with-practical-examples-7b1d93fddb63" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on October 21, 2024.</p></footer></article></body></html>