<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Designing Software Using Clean Architecture: Domain-Driven Design</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Designing Software Using Clean Architecture: Domain-Driven Design</h1>
</header>
<section data-field="subtitle" class="p-summary">
Explained with a code sample
</section>
<section data-field="body" class="e-content">
<section name="1630" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="0f81" id="0f81" class="graf graf--h3 graf--leading graf--title">Designing Software Using Clean Architecture: Domain-Driven Design</h3><h4 name="11d1" id="11d1" class="graf graf--h4 graf-after--h3 graf--subtitle">Explained with a code sample</h4><figure name="b698" id="b698" class="graf graf--figure graf-after--h4"><img class="graf-image" data-image-id="0*M0ppuIun1CRj3WJX" data-width="3999" data-height="3999" data-unsplash-photo-id="yrMq64f_Ll4" src="https://cdn-images-1.medium.com/max/800/0*M0ppuIun1CRj3WJX"><figcaption class="imageCaption">Photo by <a href="https://unsplash.com/@nublson?utm_source=medium&amp;utm_medium=referral" data-href="https://unsplash.com/@nublson?utm_source=medium&amp;utm_medium=referral" class="markup--anchor markup--figure-anchor" rel="photo-creator noopener" target="_blank">Nubelson Fernandes</a> on <a href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" data-href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" class="markup--anchor markup--figure-anchor" rel="photo-source noopener" target="_blank">Unsplash</a></figcaption></figure><p name="7302" id="7302" class="graf graf--p graf-after--figure">This article is the last of this series. We have already described the problem encountered in <a href="https://betterprogramming.pub/how-to-design-in-clean-architecture-way-part-1-36c3e558517b" data-href="https://betterprogramming.pub/how-to-design-in-clean-architecture-way-part-1-36c3e558517b" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">data-oriented design</a>. In this article, we will introduce a better way to tackle a feature requirement.</p><p name="4d12" id="4d12" class="graf graf--p graf-after--p">We continue the previous example, a sign-in mission, and try a different design flow. Before we start, let’s review the onion architecture again.</p><figure name="1608" id="1608" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="0*xAqzUzJ40tAvdG2Q.jpg" data-width="601" data-height="534" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/0*xAqzUzJ40tAvdG2Q.jpg"><figcaption class="imageCaption">Onion Architecture</figcaption></figure><p name="ee97" id="ee97" class="graf graf--p graf-after--figure">In order to make it easier to understand the process to be introduced later, let’s first define several important legends of this diagram.</p><ul class="postList"><li name="ae63" id="ae63" class="graf graf--li graf-after--p">Entity: In clean architecture, entity means the business logic. Different from the entity in domain-driven design, the entity here can be realized as the domain in domain-driven design.</li><li name="9e15" id="9e15" class="graf graf--li graf-after--li">Use cases: With the domain, the outer layer is use cases, which refers to clients who use domain knowledge to fulfill specific needs. In domain-driven design, it is also known as the domain service.</li><li name="8812" id="8812" class="graf graf--li graf-after--li">Controller: The Controller is quite simple. It is responsible for managing the ingress and egress of the entire domain, including input checking, and converting domain knowledge into a data structure that is presented on the client side.</li><li name="212c" id="212c" class="graf graf--li graf-after--li">DB: The outermost layer is the external dependencies of the system, including the database.</li><li name="add8" id="add8" class="graf graf--li graf-after--li">Arrows: The arrow pointing from the outside to the inside is a reference. The outer module can reference the inner module, but it cannot be referenced from the inside to the outside.</li></ul><p name="f470" id="f470" class="graf graf--p graf-after--li">According to this description, we can know that the order of design should be from the inside to the outside. After the inner layer is established, and then it is able to be referenced by the outer layer. In other words, to complete a design in a clean architecture way, the domain behavior must be defined first, and the database design should be the last. This is the exact opposite of data-oriented design.</p><h3 name="98ef" id="98ef" class="graf graf--h3 graf-after--p">Domain-driven Design</h3><p name="0589" id="0589" class="graf graf--p graf-after--h3">Before starting the actual design, let me explain my usual design process, which also echos the onion architecture.</p><ol class="postList"><li name="9d6d" id="9d6d" class="graf graf--li graf-after--p">Discover user stories (entities)</li><li name="4c67" id="4c67" class="graf graf--li graf-after--li">Design use cases</li><li name="1552" id="1552" class="graf graf--li graf-after--li">Model domain objects</li><li name="f4d1" id="f4d1" class="graf graf--li graf-after--li">Implement unit tests</li><li name="9a80" id="9a80" class="graf graf--li graf-after--li">Code</li></ol><p name="3098" id="3098" class="graf graf--p graf-after--li">In later sections, I will also design with this process. The problem we want to solve is to build a sign-in mission mentioned earlier.</p><h3 name="a30f" id="a30f" class="graf graf--h3 graf-after--p">Discover user stories</h3><p name="6683" id="6683" class="graf graf--p graf-after--h3">To start a design, we must be able to understand the whole picture of the entire requirement, and user stories are a language that can describe the requirements. In our needs this time, the stories are similar to the following.</p><ol class="postList"><li name="5c22" id="5c22" class="graf graf--li graf-after--p">Get corresponding rewards when you sign in consecutively.</li><li name="9490" id="9490" class="graf graf--li graf-after--li">Display the sign-in status and received rewards for this cycle.</li><li name="ea1a" id="ea1a" class="graf graf--li graf-after--li">Get 100 diamonds when opening the gift box.</li></ol><p name="3763" id="3763" class="graf graf--p graf-after--li">We convert the descriptions in the requirements document into semantics that developers can understand through an ubiquitous language. With any requirement, there must be a story behind it, and the designer’s job is to discover those stories. On the other hand, for the developers, they implement those stories in coding.</p><h3 name="c6e4" id="c6e4" class="graf graf--h3 graf-after--p">Design use cases</h3><p name="86ae" id="86ae" class="graf graf--p graf-after--h3">With the story, then we need design the use cases that the story faces. Unlike a story, a use case refers to the outcome of a given user scenario. For example:</p><ol class="postList"><li name="9aaa" id="9aaa" class="graf graf--li graf-after--p">Sign in: When a user signs in for four consecutive days, the first sign-in on the fifth day can get 30 diamonds and a gift box. But the second sign-in got nothing.</li><li name="2389" id="2389" class="graf graf--li graf-after--li">Open the gift box: When opening the gift box, you can get 100 diamonds, but it cannot be opened again.</li></ol><p name="1e1a" id="1e1a" class="graf graf--p graf-after--li">From the above description, use cases are actually an extension of user stories and describe details that are not defined in the story. Therefore, from the use cases, we can draw a flowchart to explain the whole user scenario in detail. Let’s take sign-in as an example with a flowchart.</p><figure name="6d3f" id="6d3f" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*WtFC6OlXrCqrmlsffaYV4g.png" data-width="301" data-height="672" src="https://cdn-images-1.medium.com/max/800/1*WtFC6OlXrCqrmlsffaYV4g.png"></figure><p name="6827" id="6827" class="graf graf--p graf-after--figure">Starting from the top starting point, it is the moment when the sign-in action occurs, so it is represented by <code class="markup--code markup--p-code">SignIn: now</code>. Next, we need to know how long is the difference between this sign-in and the “last sign-in” in days. If it is 0 days, it means that you have already signed in, and there is no reward to get. Or the difference is greater than 1, indicating that the sign-in is not continuous this time, and the entire cycle needs to be reset. In case of 1 exactly, it is continuous sign-in, thus the continuous date is incremented, and the current time is recorded.</p><p name="8648" id="8648" class="graf graf--p graf-after--p">Finally, check the table according to the number of consecutive days to know how many rewards you will get.</p><p name="5693" id="5693" class="graf graf--p graf-after--p">It is also easy to display how many consecutive days you have signed in. Suppose we use list to represent the signed-in records.</p><ul class="postList"><li name="93a7" id="93a7" class="graf graf--li graf-after--p">Only sign in for one day: <code class="markup--code markup--li-code">[1, 0, 0, 0, 0, 0, 0]</code></li><li name="60b4" id="60b4" class="graf graf--li graf-after--li">Sign in for three consecutive days: <code class="markup--code markup--li-code">[1, 1, 1, 0, 0, 0, 0]</code></li></ul><p name="1f74" id="1f74" class="graf graf--p graf-after--li">Therefore, we can know how many <code class="markup--code markup--p-code">1</code> to insert to the list from <code class="markup--code markup--p-code">counter</code>.</p><p name="7e6e" id="7e6e" class="graf graf--p graf-after--p">The flow of opening the gift box is similar, so I won’t explain too much here. The final code will include opening the gift box.</p><h3 name="86c8" id="86c8" class="graf graf--h3 graf-after--p">Model domain objects</h3><p name="0670" id="0670" class="graf graf--p graf-after--h3">From the use cases we can know that we will need two very important variables: <code class="markup--code markup--p-code">counter</code> and <code class="markup--code markup--p-code">last</code>. In fact, the rest of the state is determined by these two variables, so we can start modeling.</p><p name="4cf9" id="4cf9" class="graf graf--p graf-after--p">In order to describe the entire sign-in mission, I believe that each user will have its own state, so we encapsulate the user state into a domain object called <code class="markup--code markup--p-code">SignInRepo</code>. The Repository in <code class="markup--code markup--p-code">DDD</code> is used here. Then with the user state, we can describe the whole story. There are two actions in the story, <code class="markup--code markup--p-code">signIn</code> and <code class="markup--code markup--p-code">getTimeline</code>, which represent story 1 and story 2 respectively.</p><figure name="f559" id="f559" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*7Ayrd6xhBnn8UefYeG6oQg.png" data-width="389" data-height="220" src="https://cdn-images-1.medium.com/max/800/1*7Ayrd6xhBnn8UefYeG6oQg.png"></figure><p name="3d9b" id="3d9b" class="graf graf--p graf-after--figure">Because <code class="markup--code markup--p-code">SignInRepo</code> is defined on the basis of use cases, it is part of the entity in the onion architecture. According to the flowchart, it has two private variables and two public methods. The reason why <code class="markup--code markup--p-code">update</code> has a parameter is that we can see from the flowchart that we only have one operation <code class="markup--code markup--p-code">counter++, set last=now</code>, and <code class="markup--code markup--p-code">now</code> must be passed in from the outside. As for <code class="markup--code markup--p-code">SignInService</code>, it can be known from the name that it belongs to the domain service.</p><p name="fdd5" id="fdd5" class="graf graf--p graf-after--p">Once we have domain objects, we can start developing in test-driven development, TDD.</p><h3 name="2489" id="2489" class="graf graf--h3 graf-after--p">Implement unit tests</h3><p name="8fee" id="8fee" class="graf graf--p graf-after--h3">In the development process of TDD, we write the corresponding tests according to our user stories at first, and then the actual coding is carried out. Hence, in this section, we’ll explain how to write unit tests with our defined stories and models. Let’s take a regular story as an example, suppose we’ve signed in for six days continuously, and on the seventh day, we’ll get 100 diamonds and a gift box.</p><p name="7943" id="7943" class="graf graf--p graf-after--p">First, write a test based on our story.</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="javascript" name="fee0" id="fee0" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-title function_">describe</span>(<span class="hljs-string">&quot;step1&quot;</span>, <span class="hljs-function">() =&gt;</span> {<br />  <span class="hljs-title function_">it</span>(<span class="hljs-string">&quot;continuous 6d and signin 7th day&quot;</span>, <span class="hljs-function">() =&gt;</span> {<br />    <span class="hljs-keyword">const</span> user = <span class="hljs-string">&quot;User A&quot;</span>;<br />    <span class="hljs-keyword">const</span> now = <span class="hljs-string">&quot;2022-01-07 1:11:11&quot;</span>;<br />    <span class="hljs-keyword">const</span> service = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SignInService</span>(user);<br />    <br />    <span class="hljs-keyword">const</span> timeline1 = service.<span class="hljs-title function_">getTimeline</span>();<br />    <span class="hljs-title function_">expect</span>(timeline1).<span class="hljs-property">to</span>.<span class="hljs-property">deep</span>.<span class="hljs-title function_">equal</span>([<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>]);<br />    <br />    <span class="hljs-keyword">const</span> result = service.<span class="hljs-title function_">signIn</span>(now);<br />    <span class="hljs-title function_">expect</span>(result).<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-title function_">equal</span>(<span class="hljs-number">100</span>);<br />    <br />    <span class="hljs-keyword">const</span> timeline2 = service.<span class="hljs-title function_">getTimeline</span>();<br />    <span class="hljs-title function_">expect</span>(timeline2).<span class="hljs-property">to</span>.<span class="hljs-property">deep</span>.<span class="hljs-title function_">equal</span>([<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>]);<br />      <br />    <span class="hljs-keyword">const</span> result = service.<span class="hljs-title function_">signIn</span>(now);<br />    <span class="hljs-title function_">expect</span>(result).<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-title function_">equal</span>(<span class="hljs-number">0</span>);<br />  });<br />});</span></pre><p name="dbfa" id="dbfa" class="graf graf--p graf-after--pre">One of the stories is briefly described above, there is a user, A, who has signed in for six consecutive days, and when he signs in at <code class="markup--code markup--p-code">2022-01-07 1:11:11</code>, it is the seventh day to sign in. He gets 100 diamonds as our expectation.</p><p name="d24d" id="d24d" class="graf graf--p graf-after--p">But such a story is not complete, because six consecutive sign-ins have not been defined. So let’s modify the test a bit.</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="javascript" name="fc2b" id="fc2b" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-title function_">describe</span>(<span class="hljs-string">&quot;step2&quot;</span>, <span class="hljs-function">() =&gt;</span> {<br />  <span class="hljs-title function_">it</span>(<span class="hljs-string">&quot;continuous 6d and signin 7th day&quot;</span>, <span class="hljs-function">() =&gt;</span> {<br />    <span class="hljs-keyword">const</span> user = <span class="hljs-string">&quot;User A&quot;</span>;<br />    <span class="hljs-keyword">const</span> now = <span class="hljs-string">&quot;2022-01-07 1:11:11&quot;</span>;<br />    <span class="hljs-keyword">const</span> repo = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SignInRepo</span>(user);<br />    repo.<span class="hljs-title function_">restoreSingInRecord</span>(<span class="hljs-number">6</span>, <span class="hljs-string">&quot;2022-01-06 5:55:55&quot;</span>);<br />    <span class="hljs-keyword">const</span> service = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SignInService</span>(repo);<br /><br />    <span class="hljs-keyword">const</span> timeline1 = service.<span class="hljs-title function_">getTimeline</span>();<br />    <span class="hljs-title function_">expect</span>(timeline1).<span class="hljs-property">to</span>.<span class="hljs-property">deep</span>.<span class="hljs-title function_">equal</span>([<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>]);<br />    <br />    <span class="hljs-keyword">const</span> result = service.<span class="hljs-title function_">signIn</span>(now);<br />    <span class="hljs-title function_">expect</span>(result).<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-title function_">equal</span>(<span class="hljs-number">100</span>);<br />    <br />    <span class="hljs-keyword">const</span> timeline2 = service.<span class="hljs-title function_">getTimeline</span>();<br />    <span class="hljs-title function_">expect</span>(timeline2).<span class="hljs-property">to</span>.<span class="hljs-property">deep</span>.<span class="hljs-title function_">equal</span>([<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>]);<br />      <br />    <span class="hljs-keyword">const</span> result = service.<span class="hljs-title function_">signIn</span>(now);<br />    <span class="hljs-title function_">expect</span>(result).<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-title function_">equal</span>(<span class="hljs-number">0</span>);<br />  });<br />});</span></pre><p name="d3c8" id="d3c8" class="graf graf--p graf-after--pre">In order to restore the entire use cases, we newly defined a repo and added an auxiliary method: <code class="markup--code markup--p-code">restoreSingInRecord</code>. This helper can also be used as an interface to retrieve values from the database in future implementations. Subsequently, such a story is complete and can begin to go into the production code.</p><h3 name="1e3d" id="1e3d" class="graf graf--h3 graf-after--p">Code</h3><p name="16b5" id="16b5" class="graf graf--p graf-after--h3">In the previous section, we have a complete unit test, and then start implementing <code class="markup--code markup--p-code">SignInRepo</code> and <code class="markup--code markup--p-code">SignInService</code>.</p><figure name="42b7" id="42b7" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*zIdOV_9FZ1y1PUF4-IDhyw.png" data-width="436" data-height="915" src="https://cdn-images-1.medium.com/max/800/1*zIdOV_9FZ1y1PUF4-IDhyw.png"></figure><p name="e53d" id="e53d" class="graf graf--p graf-after--figure"><code class="markup--code markup--p-code">SignInRepo</code> is easy to implement when there is no database, just follow the flowchart to finish <code class="markup--code markup--p-code">update</code> and <code class="markup--code markup--p-code">reset</code>. <code class="markup--code markup--p-code">SignInService</code> is totally implemented in accordance with the use cases, and the flowchart is converted into the actual code.</p><p name="e2df" id="e2df" class="graf graf--p graf-after--p">In this way, this requirement is half completed, and the remaining process of opening the gift box is basically the same, so I will just post the final result. The full implementation can be seen as follows.</p><figure name="7115" id="7115" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/wirelessr/3555c40256e51ac7c1befa4db897941b.js"></script></figure><h3 name="4712" id="4712" class="graf graf--h3 graf-after--figure">Summary of Domain-driven Design</h3><p name="ecdd" id="ecdd" class="graf graf--p graf-after--h3">In fact, the above implementation just borrows some DDD terminologies, and does not fully implement DDD’s “prescriptions”. From my point of view, DDD provides a concept that enables people to know the importance of the domain and has the ability to abstract the domain.</p><p name="e9cd" id="e9cd" class="graf graf--p graf-after--p">That is to say, it is up to you whether to follow the textbook to implement Entity, Value Object, Aggregate, and Repository or not. It needn’t implement in DDD by following the textbook approach. The implementation depends on the proficiency and understanding of needs.</p><p name="c21c" id="c21c" class="graf graf--p graf-after--p">In this article, a standard design process is provided, so that everyone can disassemble the original requirements and convert them into models with domain knowledge by following this process.</p><p name="c6b0" id="c6b0" class="graf graf--p graf-after--p">The process of implementing the model, it begins with the corresponding tests to achieve test-driven development.</p><p name="12a4" id="12a4" class="graf graf--p graf-after--p">Of course, in the real world, it is not as simple as the example in this article. But the design process is the same, starting from the story, defining the use cases through the story, then modeling according to the use cases, writing tests according to the stories, and finally implementing it.</p><p name="a3a3" id="a3a3" class="graf graf--p graf-after--p">By the way, I explained some design details a while ago, such as:</p><ul class="postList"><li name="ee30" id="ee30" class="graf graf--li graf-after--p">Q1: Why do we need to define a repo? <a href="https://medium.com/interviewnoodle/whats-difference-between-unit-test-and-integration-test-aae6ef13220" data-href="https://medium.com/interviewnoodle/whats-difference-between-unit-test-and-integration-test-aae6ef13220" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">Dependency Injection</a></li><li name="592b" id="592b" class="graf graf--li graf-after--li">Q2: Why do we need layers? <a href="https://lazypro.medium.com/layered-architecture-clarification-e55b69d60e98" data-href="https://lazypro.medium.com/layered-architecture-clarification-e55b69d60e98" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">Layered Architecture</a></li><li name="75f2" id="75f2" class="graf graf--li graf-after--li">Q3: How to evolve a system? <a href="https://medium.com/interviewnoodle/shift-from-monolith-to-cqrs-a34bab75617e" data-href="https://medium.com/interviewnoodle/shift-from-monolith-to-cqrs-a34bab75617e" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">Shift from Monolith to CQRS</a></li></ul><p name="d9ea" id="d9ea" class="graf graf--p graf-after--li graf--trailing">If you encounter software design problems, you are also welcome to discuss them with me.</p></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@lazypro" class="p-author h-card">Chunting Wu</a> on <a href="https://medium.com/p/8524e76f2720"><time class="dt-published" datetime="2022-01-31T00:38:31.291Z">January 31, 2022</time></a>.</p><p><a href="https://medium.com/@lazypro/how-to-design-in-clean-architecture-way-part-2-8524e76f2720" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on October 21, 2024.</p></footer></article></body></html>