<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Combine Domain-Driven Design and Databases</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Combine Domain-Driven Design and Databases</h1>
</header>
<section data-field="subtitle" class="p-summary">
Explained how to integrate database in domain-driven design with a code sample
</section>
<section data-field="body" class="e-content">
<section name="7cca" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="5999" id="5999" class="graf graf--h3 graf--leading graf--title">Explain combining Domain-Driven Design and Databases</h3><figure name="d25c" id="d25c" class="graf graf--figure graf-after--h3"><img class="graf-image" data-image-id="0*BhHrlHoJcl3Heg5A.png" data-width="440" data-height="464" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/0*BhHrlHoJcl3Heg5A.png"><figcaption class="imageCaption"><a href="https://en.wikipedia.org/wiki/Gashapon" data-href="https://en.wikipedia.org/wiki/Gashapon" class="markup--anchor markup--figure-anchor" rel="nofollow noopener" target="_blank">https://en.wikipedia.org/wiki/Gashapon</a></figcaption></figure><p name="f928" id="f928" class="graf graf--p graf-after--figure">A while ago, we explained <a href="https://betterprogramming.pub/how-to-design-in-clean-architecture-way-part-2-8524e76f2720" data-href="https://betterprogramming.pub/how-to-design-in-clean-architecture-way-part-2-8524e76f2720" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">how to design software in a clean architecture way</a>. At that time, although we provided the design and implementation of the domain objects and also implemented the unit tests, we did not describe how to integrate with the database.</p><p name="622a" id="622a" class="graf graf--p graf-after--p">Therefore, this article will present another example of how domain-driven design and database can be put together. Next, we will provide a real-world design of a common street-level gashapon store with a MySQL database.</p><h3 name="19c4" id="19c4" class="graf graf--h3 graf-after--p">User Stories</h3><p name="3a1b" id="3a1b" class="graf graf--p graf-after--h3">As we’ve done before, we start by describing the user story, and we understand our needs through that story.</p><ul class="postList"><li name="3399" id="3399" class="graf graf--li graf-after--p">There will be a lot of machines, each with different combinations of items.</li><li name="5cce" id="5cce" class="graf graf--li graf-after--li">In order to allow “generous” customers to buy everything at once, we offer the option to draw a lot of items at once.</li><li name="0132" id="0132" class="graf graf--li graf-after--li">When we run out of items, we need to refill them immediately.</li><li name="81e9" id="81e9" class="graf graf--li graf-after--li">If a person who draws a lot of items at one time runs out of items, we will refill the items immediately so that they can continue to draw.</li></ul><p name="b703" id="b703" class="graf graf--p graf-after--li">Such a story is actually a scenario that happens in every gashapon store, and after a clear description, we will know how to build the domain model.</p><p name="6902" id="6902" class="graf graf--p graf-after--p">Generally speaking, we will need to model a gashapon machine and a gacha entity.</p><h3 name="154a" id="154a" class="graf graf--h3 graf-after--p">Use Cases</h3><p name="2b07" id="2b07" class="graf graf--p graf-after--h3">Then, we define more precise use cases based on user stories. Unlike a story, the use case will clearly describe what happened and how the system should react.</p><ul class="postList"><li name="b103" id="b103" class="graf graf--li graf-after--p">Because this is an online gashapon store, it is possible for multiple people to draw at the same time. But just like the physical machine, everyone must draw in order.</li><li name="967c" id="967c" class="graf graf--li graf-after--li">In the process of refilling the gacha, the user is not allowed to draw until all the gacha have been refilled.</li><li name="5643" id="5643" class="graf graf--li graf-after--li">When A and B each draw 50 at the same time, but there are only 70 in the machine, one of them will get the 50 in the batch, while the other will draw 20 first, and then wait for the refill before drawing 30.</li></ul><p name="c49e" id="c49e" class="graf graf--p graf-after--li">With the use case, we can either draw a flowchart or write a process based on it. In this example, I chose to write the process in <code class="markup--code markup--p-code">Python</code> as follows.</p><pre name="8c36" id="8c36" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">def draw(n, machine):<br>    gachas = machine.pop(n)<br>    <br>    if len(gachas) &lt; n:<br>        machine.refill()<br>        gachas += draw(n - len(gachas), machine)<br>    <br>    return gachas</code></pre><p name="4b3e" id="4b3e" class="graf graf--p graf-after--pre">In the user story, we mentioned that we will model a gashapon machine and a gacha. So the <code class="markup--code markup--p-code">machine</code> in this example code is the gashapon machine, which provides both <code class="markup--code markup--p-code">pop</code> and <code class="markup--code markup--p-code">refill</code> methods. On the other hand, gachas are a list with <code class="markup--code markup--p-code">gacha</code> in it.</p><p name="0cc1" id="0cc1" class="graf graf--p graf-after--p">Before we go any further, there is one very important thing that must be stated. Both the <code class="markup--code markup--p-code">pop</code> and <code class="markup--code markup--p-code">refill</code> methods must be atomic. To avoid racing conditions, both methods must be atomic and cannot be preempted, while there will be multiple users drawing simultaneously.</p><h3 name="76da" id="76da" class="graf graf--h3 graf-after--p">Database Modeling</h3><p name="817d" id="817d" class="graf graf--p graf-after--h3">We already have <code class="markup--code markup--p-code">machine</code> and <code class="markup--code markup--p-code">gacha</code>, and these two objects are very simple for developers who are familiar with object-oriented programming, but how should they be integrated with the database?</p><figure name="0623" id="0623" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="0*Q00QHD27370wmhWN.png" data-width="319" data-height="400" src="https://cdn-images-1.medium.com/max/800/0*Q00QHD27370wmhWN.png"></figure><p name="dc91" id="dc91" class="graf graf--p graf-after--figure">As mentioned in the book <em class="markup--em markup--p-em">Patterns of Enterprise Application Architecture</em>, there are three options to describe the domain logic on the database.</p><ol class="postList"><li name="326e" id="326e" class="graf graf--li graf-after--p">Transaction Script</li><li name="16ec" id="16ec" class="graf graf--li graf-after--li">Table Module</li><li name="8b1f" id="8b1f" class="graf graf--li graf-after--li">Domain Model</li></ol><p name="d609" id="d609" class="graf graf--p graf-after--li">The book explains the pros and cons of these three choices individually, and in my experience, I prefer to use <em class="markup--em markup--p-em">Table Module</em>. The reason is, the database is a standalone component, and to the application, the database is actually a <em class="markup--em markup--p-em">Singleton</em>. To be able to control concurrent access on this <em class="markup--em markup--p-em">Singleton</em>, it is necessary to have a single, unified and public interface.</p><p name="66d3" id="66d3" class="graf graf--p graf-after--p">With <em class="markup--em markup--p-em">Transaction Script</em>, access to the database is spread all over the source code, making it almost impossible to manage when the application grows larger. On the other hand, <em class="markup--em markup--p-em">Domain Model</em> is too complex, as it creates a specific instance for each row of the table, which is very complicated in terms of implementation atomic operations. So I chose the compromise <em class="markup--em markup--p-em">Table Module</em> as the public interface to interact with the database.</p><p name="a255" id="a255" class="graf graf--p graf-after--p">Take the above <code class="markup--code markup--p-code">machine</code> as an example.</p><p name="8eee" id="8eee" class="graf graf--p graf-after--p">Since we have finished building the domain object, let’s define the schema of the table <code class="markup--code markup--p-code">GachaTable</code>.</p><figure name="2823" id="2823" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*slvDrZSNgDq2fLp-Rv0v9g.png" data-width="1146" data-height="476" src="https://cdn-images-1.medium.com/max/800/1*slvDrZSNgDq2fLp-Rv0v9g.png"><figcaption class="imageCaption"><code class="markup--code markup--figure-code">GachaTable</code></figcaption></figure><p name="2c26" id="2c26" class="graf graf--p graf-after--figure">In the table, we can see there are two machines, one with the theme <em class="markup--em markup--p-em">Jurassic Park</em> and the other <em class="markup--em markup--p-em">Ice Age</em>, both of which have two individual gachas. The Jurassic Park machine looks like three, but one has actually been drawn already.</p><p name="4fba" id="4fba" class="graf graf--p graf-after--p"><code class="markup--code markup--p-code">Gacha</code>’s domain model is straightforward, which is <code class="markup--code markup--p-code">gacha_id</code> or more detailed, which may be the theme plus items, such as: Jurassic Park and T-Rex.</p><p name="0847" id="0847" class="graf graf--p graf-after--p">A more interesting topic to discuss is <code class="markup--code markup--p-code">machine</code>. <code class="markup--code markup--p-code">machine</code> needs to define several attributes. First, it should be able to specify an id in the constructor, and second, there are two atomic methods, <code class="markup--code markup--p-code">pop</code> and <code class="markup--code markup--p-code">refill</code>. We will focus on these two methods in the following sections.</p><h3 name="04a7" id="04a7" class="graf graf--h3 graf-after--p">Atomic Pop</h3><p name="d6b5" id="d6b5" class="graf graf--p graf-after--h3">It is not difficult to implement an atomic <code class="markup--code markup--p-code">pop</code>: first sort by sequence number, then take out the first <code class="markup--code markup--p-code">n</code> rows, and finally set <code class="markup--code markup--p-code">is_drawn</code> to <code class="markup--code markup--p-code">true</code>. Let’s take the Jurassic Park machine as an example.</p><pre name="70c8" id="70c8" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">START TRANSACTION;<br>SELECT * FROM GachaTable WHERE machine_id = 1 AND is_drawn = false ORDER BY gacha_seq LIMIT n FOR UPDATE;<br>UPDATE GachaTable SET is_drawn = true WHERE gacha_seq IN ${resultSeqs};<br>COMMIT;</code></pre><p name="c82a" id="c82a" class="graf graf--p graf-after--pre">As mentioned in <a href="https://medium.com/interviewnoodle/how-to-avoid-the-race-condition-and-the-negative-value-3f397b2b08e4" data-href="https://medium.com/interviewnoodle/how-to-avoid-the-race-condition-and-the-negative-value-3f397b2b08e4" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">my previous article</a>, in order to avoid lost updates, MySQL has three approaches. In this example, to achieve atomic updates, it is easiest to add <code class="markup--code markup--p-code">FOR UPDATE</code> to the end of <code class="markup--code markup--p-code">SELECT</code> to preempt these rows.</p><p name="5fb6" id="5fb6" class="graf graf--p graf-after--p">When the update is complete, the result of <code class="markup--code markup--p-code">SELECT</code> can be wrapped into <code class="markup--code markup--p-code">Gacha</code> instances and returned. This way the caller will be able to get the gachas drawn and know how many were drawn.</p><h3 name="90c8" id="90c8" class="graf graf--h3 graf-after--p">Atomic Refill</h3><p name="3ab0" id="3ab0" class="graf graf--p graf-after--h3">Another atomic method is <code class="markup--code markup--p-code">refill</code>. It is simple to not get interrupted in the middle of the fill process. Because MySQL transactions are not read by the rest of clients until <code class="markup--code markup--p-code">COMMIT</code> under the <code class="markup--code markup--p-code">Repeatable Read</code> condition.</p><pre name="73d4" id="73d4" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">START TRANSACTION;<br>for gacha in newGachaPackage():<br>    INSERT INTO GachaTable VALUES ${gacha};<br>    <br>COMMIT;</code></pre><p name="4bca" id="4bca" class="graf graf--p graf-after--pre">Is that all? No, not really.</p><p name="cf37" id="cf37" class="graf graf--p graf-after--p">This problem occurs when both users draw <code class="markup--code markup--p-code">n</code>, but there are not enough <code class="markup--code markup--p-code">n</code> gachas to draw.</p><figure name="5d30" id="5d30" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*7cfbBcXTSNYVrSPhgTgA0A.png" data-width="854" data-height="1072" src="https://cdn-images-1.medium.com/max/800/1*7cfbBcXTSNYVrSPhgTgA0A.png"><figcaption class="imageCaption">Redundant refill</figcaption></figure><p name="d024" id="d024" class="graf graf--p graf-after--figure">The sequential diagram above shows when A and B draw at the same time, A will draw <code class="markup--code markup--p-code">r</code> gachas and B will not, as we expected. However, both A and B will <code class="markup--code markup--p-code">refill</code> together, resulting in the same batch of gachas being filled twice.</p><p name="6fec" id="6fec" class="graf graf--p graf-after--p">Usually, this does not cause any major problems. Because we arrange the <code class="markup--code markup--p-code">pop</code> by sequence number, we can guarantee that the second batch will be drawn only after the first batch is drained. But if we want to change the item, then the new items will be released later than we expected.</p><p name="514e" id="514e" class="graf graf--p graf-after--p">On the other hand, two people are refilling at the same time so the redundancy becomes twice as much, and if the system has a very large number of simultaneous users, then the redundancy may become several times as much and take up a lot of resources.</p><p name="8d25" id="8d25" class="graf graf--p graf-after--p">How to solve this problem? In the article <a href="https://betterprogramming.pub/solve-phantom-read-in-mysql-a1c85f9a8c56" data-href="https://betterprogramming.pub/solve-phantom-read-in-mysql-a1c85f9a8c56" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Solving Phantom Reads in MySQL</a>, it is mentioned that we can materialize conflicts. In other words, we add an external synchronization mechanism to mediate all concurrent users.</p><p name="d482" id="d482" class="graf graf--p graf-after--p">In this example, we can add a new table, <code class="markup--code markup--p-code">MachineTable</code>.</p><figure name="3eac" id="3eac" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*WeEyK9FEAwIzvSuKRlT85Q.png" data-width="584" data-height="256" src="https://cdn-images-1.medium.com/max/800/1*WeEyK9FEAwIzvSuKRlT85Q.png"><figcaption class="imageCaption"><code class="markup--code markup--figure-code">MachineTable</code></figcaption></figure><p name="3c6b" id="3c6b" class="graf graf--p graf-after--figure">This table also allows the original <code class="markup--code markup--p-code">machine_id</code> of <code class="markup--code markup--p-code">GachaTable</code> to have an additional foreign key reference target. When we do <code class="markup--code markup--p-code">refill</code>, we have to lock this machine first before we can update it.</p><pre name="59ec" id="59ec" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">START TRANSACTION;<br>SELECT * FROM MachineTable WHERE machine_id = 1 FOR UPDATE;<br>SELECT COUNT(*) FROM GachaTable WHERE machine_id = 1 AND is_drawn = false;<br>if !cnt:<br>    for gacha in newGachaPackage():<br>        INSERT INTO GachaTable VALUES ${gacha};<br>    <br>COMMIT;</code></pre><p name="1418" id="1418" class="graf graf--p graf-after--pre">At first, we acquire the exclusive lock, then we re-confirm whether <code class="markup--code markup--p-code">GachaTable</code> needs <code class="markup--code markup--p-code">refill</code>, and finally, we actually insert the data into it. If it is not reconfirmed, then it is still possible to repeat <code class="markup--code markup--p-code">refill</code>.</p><p name="c8e5" id="c8e5" class="graf graf--p graf-after--p">Here are a few extended discussions.</p><ol class="postList"><li name="e0f9" id="e0f9" class="graf graf--li graf-after--p">Why do we need an additional <code class="markup--code markup--li-code">MachineTable</code>? Can’t we lock the original <code class="markup--code markup--li-code">GachaTable</code>? Due to phantom reads, MySQL’s <code class="markup--code markup--li-code">Repeatable Read</code> cannot avoid write skew from phantom reads in the case of new data. The detailed process is explained in <a href="https://betterprogramming.pub/solve-phantom-read-in-mysql-a1c85f9a8c56" data-href="https://betterprogramming.pub/solve-phantom-read-in-mysql-a1c85f9a8c56" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">my previous article</a>.</li><li name="ea19" id="ea19" class="graf graf--li graf-after--li">When locking <code class="markup--code markup--li-code">MachineTable</code>, don’t you need to lock <code class="markup--code markup--li-code">GachaTable</code> when getting the count from <code class="markup--code markup--li-code">GachaTable</code>? Actually, it is not necessary. Because it will enter the <code class="markup--code markup--li-code">refill</code> process, it must be because the gachas have been drawn and everyone is waiting for the <code class="markup--code markup--li-code">refill</code>, so don’t worry about the <code class="markup--code markup--li-code">pop</code>.</li></ol><h3 name="2d4d" id="2d4d" class="graf graf--h3 graf-after--li">Conclusion</h3><p name="9991" id="9991" class="graf graf--p graf-after--h3">In this article, we explain the issues to be considered when combining a domain-driven design with a database design through a real-world example.</p><p name="320e" id="320e" class="graf graf--p graf-after--p">The final result will contain two objects, <code class="markup--code markup--p-code">Gacha</code> and <code class="markup--code markup--p-code">Machine</code>, and the database will also contain two tables, <code class="markup--code markup--p-code">GachaTable</code> and <code class="markup--code markup--p-code">MachineTable</code>. All methods within <code class="markup--code markup--p-code">Machine</code> are atomic in nature.</p><p name="3179" id="3179" class="graf graf--p graf-after--p">As we described in the design steps before, we need to first define the correct user stories and use cases, then start the modeling, and finally the implementation. Unlike normal application implementations, the database exists as a large <em class="markup--em markup--p-em">Singleton</em>, so we need to better integrate the database design into our domain design as well.</p><p name="b45a" id="b45a" class="graf graf--p graf-after--p">In order to minimize the impact of the database on the overall design, it is crucial to build the domain model correctly. Of course, in this article we adopt the <em class="markup--em markup--p-em">Table Module</em> approach to domain design, which has its advantages and disadvantages.</p><p name="76ac" id="76ac" class="graf graf--p graf-after--p">The advantage is by using the <code class="markup--code markup--p-code">Machine</code> domain model, we are able to simulate the real appearance of a gashapon machine and provide a common interface for all users to synchronize their processing. By encapsulating the gashapon behavior into <code class="markup--code markup--p-code">Machine</code>, future gashapon extensions can be easily performed. All the operations of <code class="markup--code markup--p-code">GachaTable</code> and <code class="markup--code markup--p-code">MachineTable</code> will also be controlled by a single object.</p><p name="e10c" id="e10c" class="graf graf--p graf-after--p">The downside is that <code class="markup--code markup--p-code">Machine</code> actually contains the gashapon machine and the gacha table inside, which is too rough for a strict object-oriented religion. When more people are involved in the project, everyone’s understanding of the objects and the data tables begins to diverge, leading to a design collapse. For a large organization, the <em class="markup--em markup--p-em">Table Module</em> has its scope, and better cross-departmental collaboration relies on complete documentation and design reviews, which can affect everyone’s productivity.</p><p name="2716" id="2716" class="graf graf--p graf-after--p">In this article we do not take too much time to explain the design process, but rather focus on how to integrate the database design in the domain objects. If you want to learn more about the details mentioned in this article, I have listed my previous articles below.</p><ul class="postList"><li name="7423" id="7423" class="graf graf--li graf-after--p"><a href="https://medium.com/interviewnoodle/how-to-avoid-the-race-condition-and-the-negative-value-3f397b2b08e4" data-href="https://medium.com/interviewnoodle/how-to-avoid-the-race-condition-and-the-negative-value-3f397b2b08e4" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">Solve Lost Updates in MySQL</a></li><li name="ab67" id="ab67" class="graf graf--li graf-after--li"><a href="https://betterprogramming.pub/solve-phantom-read-in-mysql-a1c85f9a8c56" data-href="https://betterprogramming.pub/solve-phantom-read-in-mysql-a1c85f9a8c56" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">Solve Phantom Read in MySQL</a></li><li name="1f53" id="1f53" class="graf graf--li graf-after--li graf--trailing"><a href="https://betterprogramming.pub/how-to-design-in-clean-architecture-way-part-2-8524e76f2720" data-href="https://betterprogramming.pub/how-to-design-in-clean-architecture-way-part-2-8524e76f2720" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">Designing Software Using Clean Architecture: Domain-Driven Design</a></li></ul></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@lazypro" class="p-author h-card">Chunting Wu</a> on <a href="https://medium.com/p/747fa36ec642"><time class="dt-published" datetime="2022-06-27T01:00:09.124Z">June 27, 2022</time></a>.</p><p><a href="https://medium.com/@lazypro/combine-domain-driven-design-and-databases-747fa36ec642" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on October 21, 2024.</p></footer></article></body></html>