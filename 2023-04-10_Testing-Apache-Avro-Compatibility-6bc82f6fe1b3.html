<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Testing Apache Avro Compatibility</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Testing Apache Avro Compatibility</h1>
</header>
<section data-field="subtitle" class="p-summary">
Experimenting in Python with specific Avro compatibility scenarios
</section>
<section data-field="body" class="e-content">
<section name="261a" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="04e5" id="04e5" class="graf graf--h3 graf--leading graf--title">Testing Apache Avro Compatibility</h3><h4 name="9494" id="9494" class="graf graf--h4 graf-after--h3 graf--subtitle">Experimenting in Python with specific Avro compatibility scenarios</h4><figure name="527f" id="527f" class="graf graf--figure graf-after--h4"><img class="graf-image" data-image-id="0*NQoDMVQ824tJeGeV" data-width="1000" data-height="667" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/0*NQoDMVQ824tJeGeV"><figcaption class="imageCaption">Photo by <a href="https://unsplash.com/@lunarts" data-href="https://unsplash.com/@lunarts" class="markup--anchor markup--figure-anchor" rel="noopener" target="_blank">Volodymyr Hryshchenko</a> on <a href="https://unsplash.com/photos/ZT9gjcJog6U" data-href="https://unsplash.com/photos/ZT9gjcJog6U" class="markup--anchor markup--figure-anchor" rel="noopener" target="_blank">Unsplash</a></figcaption></figure><p name="da3c" id="da3c" class="graf graf--p graf-after--figure">There is a complete article on Avro compatibility and what should we do in the various compatibility modes.</p><div name="71a8" id="71a8" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://medium.com/expedia-group-tech/handling-incompatible-schema-changes-with-avro-2bc147e26770" data-href="https://medium.com/expedia-group-tech/handling-incompatible-schema-changes-with-avro-2bc147e26770" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://medium.com/expedia-group-tech/handling-incompatible-schema-changes-with-avro-2bc147e26770"><strong class="markup--strong markup--mixtapeEmbed-strong">Handling Incompatible Schema Changes with Avro</strong><br><em class="markup--em markup--mixtapeEmbed-em">What should you do when you need to make a breaking change to your data model?</em>medium.com</a><a href="https://medium.com/expedia-group-tech/handling-incompatible-schema-changes-with-avro-2bc147e26770" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="1b6a2e28bf759e5ad8d991d206a19f76" data-thumbnail-img-id="1*bFg2T0xmNA3On5wQGKZfGw.jpeg" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/1*bFg2T0xmNA3On5wQGKZfGw.jpeg);"></a></div><p name="8bee" id="8bee" class="graf graf--p graf-after--mixtapeEmbed">In my opinion, this article is really good and makes it easy to understand how to make a breaking change with Avro format. But I still want to actually test what results these steps will have, so this article records my experimental process.</p><p name="ce3c" id="ce3c" class="graf graf--p graf-after--p">First, we build an experimental environment, basically we only need a schema registry. I choose Confluent Schema Registry, mainly because it’s simple to deploy and use, and the <a href="https://github.com/confluentinc/cp-all-in-one" data-href="https://github.com/confluentinc/cp-all-in-one" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Confluent official document</a> provides a complete local experimental environment. Nevertheless, I only need two core components, the broker and the schema-registry.</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="yaml" name="24dd" id="24dd" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-attr">version:</span> <span class="hljs-string">&#x27;2&#x27;</span><br /><span class="hljs-attr">services:</span><br />  <span class="hljs-attr">zookeeper:</span><br />    <span class="hljs-attr">image:</span> <span class="hljs-string">confluentinc/cp-zookeeper:7.2.1</span><br />    <span class="hljs-attr">hostname:</span> <span class="hljs-string">zookeeper</span><br />    <span class="hljs-attr">container_name:</span> <span class="hljs-string">zookeeper</span><br />    <span class="hljs-attr">ports:</span><br />      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;2181:2181&quot;</span><br />    <span class="hljs-attr">environment:</span><br />      <span class="hljs-attr">ZOOKEEPER_CLIENT_PORT:</span> <span class="hljs-number">2181</span><br />      <span class="hljs-attr">ZOOKEEPER_TICK_TIME:</span> <span class="hljs-number">2000</span><br /><br />  <span class="hljs-attr">broker:</span><br />    <span class="hljs-attr">image:</span> <span class="hljs-string">confluentinc/cp-server:7.2.1</span><br />    <span class="hljs-attr">hostname:</span> <span class="hljs-string">broker</span><br />    <span class="hljs-attr">container_name:</span> <span class="hljs-string">broker</span><br />    <span class="hljs-attr">depends_on:</span><br />      <span class="hljs-bullet">-</span> <span class="hljs-string">zookeeper</span><br />    <span class="hljs-attr">ports:</span><br />      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;9092:9092&quot;</span><br />      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;9101:9101&quot;</span><br />    <span class="hljs-attr">environment:</span><br />      <span class="hljs-attr">KAFKA_BROKER_ID:</span> <span class="hljs-number">1</span><br />      <span class="hljs-attr">KAFKA_ZOOKEEPER_CONNECT:</span> <span class="hljs-string">&#x27;zookeeper:2181&#x27;</span><br />      <span class="hljs-attr">KAFKA_LISTENER_SECURITY_PROTOCOL_MAP:</span> <span class="hljs-string">PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT</span><br />      <span class="hljs-attr">KAFKA_ADVERTISED_LISTENERS:</span> <span class="hljs-string">PLAINTEXT://broker:29092,PLAINTEXT_HOST://0.0.0.0:9092</span><br />      <span class="hljs-attr">KAFKA_METRIC_REPORTERS:</span> <span class="hljs-string">io.confluent.metrics.reporter.ConfluentMetricsReporter</span><br />      <span class="hljs-attr">KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR:</span> <span class="hljs-number">1</span><br />      <span class="hljs-attr">KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS:</span> <span class="hljs-number">0</span><br />      <span class="hljs-attr">KAFKA_CONFLUENT_LICENSE_TOPIC_REPLICATION_FACTOR:</span> <span class="hljs-number">1</span><br />      <span class="hljs-attr">KAFKA_CONFLUENT_BALANCER_TOPIC_REPLICATION_FACTOR:</span> <span class="hljs-number">1</span><br />      <span class="hljs-attr">KAFKA_TRANSACTION_STATE_LOG_MIN_ISR:</span> <span class="hljs-number">1</span><br />      <span class="hljs-attr">KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR:</span> <span class="hljs-number">1</span><br />      <span class="hljs-attr">KAFKA_JMX_PORT:</span> <span class="hljs-number">9101</span><br />      <span class="hljs-attr">KAFKA_JMX_HOSTNAME:</span> <span class="hljs-string">localhost</span><br />      <span class="hljs-attr">KAFKA_CONFLUENT_SCHEMA_REGISTRY_URL:</span> <span class="hljs-string">http://schema-registry:8081</span><br />      <span class="hljs-attr">CONFLUENT_METRICS_REPORTER_BOOTSTRAP_SERVERS:</span> <span class="hljs-string">broker:29092</span><br />      <span class="hljs-attr">CONFLUENT_METRICS_REPORTER_TOPIC_REPLICAS:</span> <span class="hljs-number">1</span><br />      <span class="hljs-attr">CONFLUENT_METRICS_ENABLE:</span> <span class="hljs-string">&#x27;true&#x27;</span><br />      <span class="hljs-attr">CONFLUENT_SUPPORT_CUSTOMER_ID:</span> <span class="hljs-string">&#x27;anonymous&#x27;</span><br />      <br />  <span class="hljs-attr">schema-registry:</span><br />    <span class="hljs-attr">image:</span> <span class="hljs-string">confluentinc/cp-schema-registry:7.2.1</span><br />    <span class="hljs-attr">hostname:</span> <span class="hljs-string">schema-registry</span><br />    <span class="hljs-attr">container_name:</span> <span class="hljs-string">schema-registry</span><br />    <span class="hljs-attr">depends_on:</span><br />      <span class="hljs-bullet">-</span> <span class="hljs-string">broker</span><br />    <span class="hljs-attr">ports:</span><br />      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;8081:8081&quot;</span><br />    <span class="hljs-attr">environment:</span><br />      <span class="hljs-attr">SCHEMA_REGISTRY_HOST_NAME:</span> <span class="hljs-string">schema-registry</span><br />      <span class="hljs-attr">SCHEMA_REGISTRY_KAFKASTORE_BOOTSTRAP_SERVERS:</span> <span class="hljs-string">&#x27;broker:29092&#x27;</span><br />      <span class="hljs-attr">SCHEMA_REGISTRY_LISTENERS:</span> <span class="hljs-string">http://0.0.0.0:8081</span></span></pre><p name="7e40" id="7e40" class="graf graf--p graf-after--pre">Next, let’s follow the steps in the reference document to actually evolve a field, in other words, evolve a string field into a record field.</p><p name="b6c0" id="b6c0" class="graf graf--p graf-after--p">I wonder what happens in the following scenarios in the default <code class="markup--code markup--p-code">BACKWARD</code> compatibility mode, and also how the unworkable scenarios described in the article will be presented.</p><ol class="postList"><li name="8c11" id="8c11" class="graf graf--li graf-after--p">The consumer is fully engaged in the producer’s schema.</li><li name="1b56" id="1b56" class="graf graf--li graf-after--li">The consumer only uses the initial schema.</li><li name="ecd1" id="ecd1" class="graf graf--li graf-after--li">The consumer lags behind the producer’s version.</li></ol><p name="377f" id="377f" class="graf graf--p graf-after--li">The whole experiment process is as follows.</p><figure name="0671" id="0671" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/wirelessr/f8680b319e9a98af1440c68237182015.js"></script></figure><p name="a57c" id="a57c" class="graf graf--p graf-after--figure">To run this script needs to install the dependency first.</p><blockquote name="d9e1" id="d9e1" class="graf graf--blockquote graf-after--p"><em class="markup--em markup--blockquote-em">pip install confluent-kafka fastavro</em></blockquote><p name="a94e" id="a94e" class="graf graf--p graf-after--blockquote">The execution results are actually as expected, i.e., there are no problems, and the consumer only parses the parts that can be understood.</p><p name="5c55" id="5c55" class="graf graf--p graf-after--p">In addition, if the compatibility mode is <code class="markup--code markup--p-code">BACKWARD_TRANSITIVE</code>, the following error will be encountered.</p><blockquote name="8228" id="8228" class="graf graf--blockquote graf-after--p"><em class="markup--em markup--blockquote-em">SchemaRegistryError: Schema being registered is incompatible with an earlier schema for subject “example.test.BACKWARD_TRANSITIVE-value”, details: [Incompatibility{type:READER_FIELD_MISSING_DEFAULT_VALUE, location:/fields/0, message:person_name, reader:{“type”:“record”,“name”:“Person”,“namespace”:“example.test.BACKWARD_TRANSITIVE”,“fields”:[{“name”:“person_name”,“type”:{“type”:“record”,“name”:“Name”,“fields”:[{“name”:“first_name”,“type”:“string”},{“name”:“last_name”,“type”:“string”}]}}]}, writer:{“type”:“record”,“name”:“Person”,“namespace”:“example.test.BACKWARD_TRANSITIVE”,“fields”:[{“name”:“name”,“type”:“string”,“default”:“&lt;DEPRECATED&gt;”}]}}] (HTTP status code 409, SR code 409)</em></blockquote><p name="bb3c" id="bb3c" class="graf graf--p graf-after--blockquote">On the other hand, if it is <code class="markup--code markup--p-code">FORWARD_TRANSITIVE</code>, we will encounter the following.</p><blockquote name="b26a" id="b26a" class="graf graf--blockquote graf-after--p"><em class="markup--em markup--blockquote-em">SchemaRegistryError: Schema being registered is incompatible with an earlier schema for subject “example.test.FORWARD_TRANSITIVE-value”, details: [Incompatibility{type:READER_FIELD_MISSING_DEFAULT_VALUE, location:/fields/0, message:name, reader:{“type”:“record”,“name”:“Person”,“namespace”:“example.test.FORWARD_TRANSITIVE”,“fields”:[{“name”:“name”,“type”:“string”}]}, writer:{“type”:“record”,“name”:“Person”,“namespace”:“example.test.FORWARD_TRANSITIVE”,“fields”:[{“name”:“person_name”,“type”:{“type”:“record”,“name”:“Name”,“fields”:[{“name”:“first_name”,“type”:“string”,“default”:“&lt;NOT_IN_USE&gt;”},{“name”:“last_name”,“type”:“string”,“default”:“&lt;NOT_IN_USE&gt;”}]},“default”:{“first_name”:“&lt;??&gt;”,“last_name”:“&lt;??&gt;”}}]}}] (HTTP status code 409, SR code 409)</em></blockquote><p name="bcf7" id="bcf7" class="graf graf--p graf-after--blockquote">The above error also occurs at the corresponding step and cannot be continued, as stated in the reference document.</p><h3 name="f747" id="f747" class="graf graf--h3 graf-after--p">Conclusion</h3><p name="3f39" id="3f39" class="graf graf--p graf-after--h3">This article is mainly about the experimental process, but after experiencing it, it is also better to understand the best practices that should be followed for schema evolution.</p><p name="835c" id="835c" class="graf graf--p graf-after--p">The best practice principles for schema evolution are mentioned in this article.</p><div name="6baa" id="6baa" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://blog.sysco.no/kafka/ConfluentKafkaSchemaRegistryPart1/" data-href="https://blog.sysco.no/kafka/ConfluentKafkaSchemaRegistryPart1/" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://blog.sysco.no/kafka/ConfluentKafkaSchemaRegistryPart1/"><strong class="markup--strong markup--mixtapeEmbed-strong">Kafka - Confluent Schema Registry. Part 1</strong><br><em class="markup--em markup--mixtapeEmbed-em">Let&#39;s talk about Kafka Schema Registry essentials. Repository contains examples of schema evolution - full…</em>blog.sysco.no</a><a href="https://blog.sysco.no/kafka/ConfluentKafkaSchemaRegistryPart1/" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="3cae35752db5f2be165264047b1b0734" data-thumbnail-img-id="0*hOkd9zICLA7lVeKw" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*hOkd9zICLA7lVeKw);"></a></div><ol class="postList"><li name="e5db" id="e5db" class="graf graf--li graf-after--mixtapeEmbed">Make your primary key required.</li><li name="b63a" id="b63a" class="graf graf--li graf-after--li">Give default values to all the fields that could be removed in the future.</li><li name="2441" id="2441" class="graf graf--li graf-after--li">Be very careful when using ENUM as the can not evolve over time.</li><li name="601c" id="601c" class="graf graf--li graf-after--li">Do not rename fields. You can add aliases instead.</li><li name="2049" id="2049" class="graf graf--li graf-after--li">When evolving schema, ALWAYS give default values.</li><li name="1b2d" id="1b2d" class="graf graf--li graf-after--li">When evolving schema, NEVER remove, rename of the required field or change the type.</li></ol><p name="a8ab" id="a8ab" class="graf graf--p graf-after--li graf--trailing">I’m not sure where his source is from, but the descriptions match my past experience quite well.</p></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@lazypro" class="p-author h-card">Chunting Wu</a> on <a href="https://medium.com/p/6bc82f6fe1b3"><time class="dt-published" datetime="2023-04-10T01:42:48.759Z">April 10, 2023</time></a>.</p><p><a href="https://medium.com/@lazypro/testing-apache-avro-compatibility-6bc82f6fe1b3" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on October 21, 2024.</p></footer></article></body></html>